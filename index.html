<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bản đồ tài chính cá nhân — v3 (fix add + ngăn cách nghìn)</title>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{ --aia:#C81E26; }
    body{ font-family:"Be Vietnam Pro", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card{ background:#fff; border:1px solid #E5E7EB; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .section-title{ font-size:1.25rem; font-weight:700; color:var(--aia); }
    .form-input, .form-select{ width:100%; background:#fff; border:1px solid #D1D5DB; border-radius:.5rem; padding:.6rem .75rem; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.6rem .9rem; border-radius:.6rem; font-weight:600; }
    .btn-primary{ background:var(--aia); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; background:#F3F4F6; border:1px solid #E5E7EB; padding:.25rem .6rem; font-size:.9rem; margin-right:.5rem; margin-bottom:.5rem; }
    .chip button{ margin-left:.5rem; color:#6B7280; }
    .dnd .item{ padding:10px 12px; border:1px dashed #cbd5e1; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:space-between; cursor:grab; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    @media print{ .no-print{display:none!important;} .page-break{page-break-after:always;} .card{box-shadow:none;border:0} }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="flex items-center justify-between pb-6 border-b-2" style="border-color:var(--aia)">
      <div class="flex items-center gap-3">
        <img src="https://www.aia.com.vn/content/dam/group-wise/images/system/icons/aia-logo-red.svg" alt="AIA Logo" class="h-8"/>
        <h1 class="text-2xl sm:text-3xl font-bold">Bản đồ tài chính cá nhân</h1>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-preview" type="button" class="btn btn-ghost">Xem bản in</button>
        <button id="btn-print" type="button" class="btn btn-primary">Xuất PDF</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6" id="app">
      <div class="lg:col-span-2 space-y-6">
        <!-- Thông tin chung -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Thông tin chung</h2><span class="text-xs text-gray-600">Phần đầu</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm text-gray-600 mb-1">Họ và tên</label><input id="fullname" class="form-input" placeholder="Nguyễn Văn A"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ngày sinh</label><input id="dob" type="date" class="form-input"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Nghề nghiệp</label><input id="job" class="form-input" placeholder="Chuyên viên tài chính..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Người phụ thuộc trực tiếp</label><input id="dep-direct" class="form-input" placeholder="Vợ/chồng, con nhỏ..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Người phụ thuộc gián tiếp</label><input id="dep-indirect" class="form-input" placeholder="Bố mẹ, thân nhân..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Video 1: Chiếc thuyền ra khơi (URL)</label><input id="vid-boat" type="url" class="form-input" placeholder="https://..."/></div>
          </div>
        </section>

        <!-- Video gặp bão -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Video gặp bão</h2><span class="text-xs text-gray-600">Phần 8</span>
          </div>
          <label class="block text-sm text-gray-600 mb-1">Video 2: Đi biển gặp bão (URL)</label>
          <input id="vid-storm" type="url" class="form-input" placeholder="https://..."/>
        </section>

        <!-- Mục tiêu & bắt buộc -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Mục tiêu/Kế hoạch</h2><span class="text-xs text-gray-600">Phần 2 &amp; 3</span>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Thêm mục tiêu (gợi ý)</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <input id="goal-input" list="goal-suggest" class="form-input" placeholder="Ví dụ: Vận hành gia đình"/>
                <datalist id="goal-suggest">
                  <option value="Vận hành gia đình"></option>
                  <option value="Quỹ học vấn cho con"></option>
                  <option value="Quỹ hưu trí"></option>
                  <option value="Trả nợ"></option>
                  <option value="Gia tăng tài sản/ Để lại di sản"></option>
                  <option value="Mở doanh nghiệp riêng"></option>
                </datalist>
              </div>
              <div class="flex items-end"><button id="add-goal" type="button" class="btn btn-primary w-full">Thêm mục tiêu</button></div>
            </div>
            <div class="mt-3" id="goals"></div>
            <div class="my-4 border-t"></div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Những mục tiêu bắt buộc phải làm bằng mọi giá (chọn nhiều)</label>
            <select id="must-goals" multiple size="6" class="form-select"></select>
            <p class="text-xs text-gray-500 mt-1">Giữ Ctrl/Cmd để chọn nhiều.</p>
          </div>
        </section>

        <!-- Lý do -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Lý do bắt buộc</h2><span class="text-xs text-gray-600">Phần 4</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-600 mb-1">Thêm lý do</label>
              <input id="reason-input" class="form-input" placeholder="Ví dụ: Bảo vệ con cái trước rủi ro"/>
            </div>
            <div class="flex items-end"><button id="add-reason" type="button" class="btn btn-primary w-full">Thêm lý do</button></div>
          </div>
          <div class="mt-3" id="reasons"></div>
        </section>

        <!-- Ưu tiên -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Ưu tiên mục tiêu</h2><span class="text-xs text-gray-600">Phần 5</span>
          </div>
          <p class="text-gray-600 text-sm mb-2">Kéo thả từ <b>quan trọng nhất</b> xuống <b>ít quan trọng nhất</b>. Danh sách lấy từ mục 3.</p>
          <div class="dnd space-y-2" id="priority-list"></div>
        </section>

        <!-- Đồng hành & thời hạn -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Thành viên cùng thực hiện &amp; Thời hạn</h2><span class="text-xs text-gray-600">Phần 6 &amp; 7</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Có ai cùng thực hiện mục tiêu không?</label>
              <div class="flex items-center gap-6">
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="no" checked/> Không</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="yes"/> Có</label>
              </div>
            </div>
            <div id="partner-perc-wrap" style="display:none">
              <label class="block text-sm text-gray-600 mb-1">% công sức của anh/chị</label>
              <input id="partner-perc" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
            <div><label class="block text-sm text-gray-600 mb-1">Dự định hoàn thành tất cả trong (năm)</label><input id="years-all" type="number" min="0" step="1" class="form-input" placeholder="Số năm"/></div>
          </div>
        </section>

        <!-- Rào cản & phương án -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Rào cản &amp; Phương án</h2><span class="text-xs text-gray-600">Phần 9–11</span>
          </div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">9) Yếu tố khiến không đạt mục tiêu</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Thêm yếu tố</label><input id="risk-input" class="form-input" placeholder="Ví dụ: Ốm đau, thất nghiệp..."/></div>
              <div class="flex items-end"><button id="add-risk" type="button" class="btn btn-primary w-full">Thêm yếu tố</button></div>
            </div>
            <div id="risks" class="mt-3"></div>
          </details>
          <div class="border-t my-3"></div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">10) Yếu tố không thể lường trước &amp; không thể khắc phục (chọn nhiều)</summary>
            <select id="unmit-select" multiple size="6" class="form-select w-full mt-2"></select>
            <p class="text-xs text-gray-500">Chọn từ danh sách đã nhập ở câu 9.</p>
          </details>
          <div class="border-t my-3"></div>
          <details open>
            <summary class="cursor-pointer font-semibold">11) Phương án thay thế</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Thêm phương án</label><input id="alt-input" class="form-input" placeholder="Ví dụ: Dự phòng 12 tháng chi tiêu..."/></div>
              <div class="flex items-end"><button id="add-alt" type="button" class="btn btn-primary w-full">Thêm phương án</button></div>
            </div>
            <div id="alts" class="mt-3"></div>
          </details>
        </section>

        <!-- Các quỹ cần thiết -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">12) Các quỹ cần thiết</h2><span class="text-xs text-gray-600">Tự động hiển thị theo ưu tiên</span>
          </div>
          <div id="funds">
            <details id="fund-family" open class="mb-4">
              <summary class="cursor-pointer font-semibold">Vận hành gia đình</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Chi phí thiết yếu / tháng (₫)</label><input id="fam-monthly" type="text" inputmode="numeric" class="form-input" data-money placeholder="XX"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Trang trải tối thiểu trong (năm)</label><input id="fam-years" type="number" min="0" step="1" class="form-input" placeholder="YY"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Quỹ vận hành gia đình cần có</label><div id="fam-total" class="font-bold text-[var(--aia)] mono mt-2">₫0</div></div>
              </div>
            </details>

            <details id="fund-edu" class="mb-4">
              <summary class="cursor-pointer font-semibold">Quỹ học vấn đại học cho con</summary>
              <div id="children" class="mt-3"></div>
              <div class="flex items-center gap-3 mt-3">
                <button id="add-child" type="button" class="btn btn-ghost border w-fit">+ Thêm con</button>
                <span class="text-sm text-gray-600">Tối đa 6 con.</span>
              </div>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">Tổng quỹ học vấn</label><div id="edu-total" class="font-bold text-[var(--aia)] mono">₫0</div></div>
            </details>

            <details id="fund-retire" class="mb-4">
              <summary class="cursor-pointer font-semibold">Quỹ hưu trí</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Tuổi nghỉ hưu</label><input id="ret-age" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Sống an nhàn trong (năm) – xx</label><input id="ret-years" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Chi tiêu cá nhân / tháng – yy (₫)</label><input id="ret-month" type="text" inputmode="numeric" class="form-input" data-money/></div>
              </div>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">Tổng quỹ hưu trí = xx × yy × 12</label><div id="ret-total" class="font-bold text-[var(--aia)] mono">₫0</div></div>
            </details>

            <details id="fund-debt" class="mb-4">
              <summary class="cursor-pointer font-semibold">Thanh khoản các khoản nợ</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Khoản nợ hiện tại (₫)</label><input id="debt-amt" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Thời hạn cần trả (năm)</label><input id="debt-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>

            <details id="fund-legacy">
              <summary class="cursor-pointer font-semibold">Gia tăng tài sản / Để lại di sản</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Giá trị tài sản kỳ vọng (₫)</label><input id="legacy-amt" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Thời gian dự kiến (năm)</label><input id="legacy-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>
          </div>
        </section>
      </div>

      <!-- Bảng tổng hợp -->
      <aside class="lg:col-span-1">
        <section class="card p-5 sticky top-8">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Tổng hợp quỹ trách nhiệm</h2>
            <button id="btn-calc" type="button" class="btn btn-ghost no-print">Cập nhật tổng hợp</button>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <h3 class="font-semibold">Số tiền trách nhiệm – <span class="text-gray-500">cần luôn sẵn sàng</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">Mục</th><th class="py-2 text-right">Số tiền (₫)</th></tr></thead>
                <tbody id="resp-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">Tổng</td><td id="resp-total" class="py-2 text-right font-semibold mono">₫0</td></tr></tfoot>
              </table>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Số tiền trách nhiệm đã chuẩn bị (₫)</label><input id="resp-prepared" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div class="flex flex-col"><span class="text-gray-700">Khoảng thiếu (ước tính)</span><span id="resp-gap" class="font-bold text-red-600 mono text-lg mt-1">₫0</span></div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold">Số tiền phải tích luỹ – <span class="text-gray-500">dùng trong tương lai</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">Mục</th><th class="py-2 text-right">Số tiền (₫)</th></tr></thead>
                <tbody id="save-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">Tổng</td><td id="save-total" class="py-2 text-right font-semibold mono">₫0</td></tr></tfoot>
              </table>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">Mong muốn hoàn thành (%)</label><input id="goal-percent" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/></div>
            </div>
          </div>
        </section>
      </aside>
    </main>

    <div class="no-print fixed bottom-0 inset-x-0 bg-white/85 backdrop-blur border-t">
      <div class="container mx-auto p-3 flex items-center gap-3">
        <p class="text-sm text-gray-600">💡 Nhấn <b>Xem bản in</b> để xem PDF trước khi xuất.</p>
        <span class="flex-1"></span>
        <button id="btn-reset" type="button" class="btn btn-ghost">Xoá dữ liệu</button>
        <button id="btn-print-2" type="button" class="btn btn-primary">Xuất PDF</button>
      </div>
    </div>

    <!-- Print preview -->
    <section id="print-view" class="mt-10 hidden">
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">Tóm tắt khách hàng</h2>
        <div id="print-client" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">Mục tiêu & Ưu tiên</h2>
        <div id="print-goals" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">Các quỹ & Tổng hợp</h2>
        <div id="print-funds" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== Utils =====
    const fmt = new Intl.NumberFormat('vi-VN');
    const el = id => document.getElementById(id);
    const money = v => '₫' + fmt.format(Number(v||0));
    const digitsOnly = s => (s||'').toString().replace(/\D/g,''); // bỏ mọi ký tự không phải số
    const getNum = id => Number(digitsOnly(el(id)?.value)||0);

    // Gắn mask tiền (thêm dấu . ngăn cách nghìn) cho mọi input có data-money
    function bindMoneyMask(input){
      if(!input) return;
      const format = () => {
        const raw = digitsOnly(input.value);
        input.value = raw ? fmt.format(Number(raw)) : '';
      };
      input.addEventListener('input', (e)=>{ format(); calcAll(); });
      input.addEventListener('blur', format);
      // khởi tạo nếu có sẵn giá trị
      format();
    }
    function bindAllMoneyMasks(scope=document){
      scope.querySelectorAll('input[data-money]').forEach(bindMoneyMask);
    }

    const state = { goals:[], mustGoals:[], reasons:[], risks:[], unmitigable:[], alts:[], children:[], _priority:[] };

    // ===== Chips =====
    function renderChips(arr, mountId){
      const mount = el(mountId); mount.innerHTML='';
      arr.forEach((txt,i)=>{
        const chip = document.createElement('span');
        chip.className='chip';
        chip.innerHTML = '<span>'+txt+'</span><button title="Xoá" data-i="'+i+'">×</button>';
        chip.querySelector('button').onclick = ()=>{ arr.splice(i,1); render(); };
        mount.appendChild(chip);
      });
    }
    function uniquePush(arr, item){
      const s = (item||'').trim(); if(!s) return; if(!arr.includes(s)) arr.push(s);
    }

    // ===== Ưu tiên (drag) =====
    function buildPriorityList(){
      const mount = el('priority-list'); mount.innerHTML='';
      let ordered = state.mustGoals.filter(g=>state._priority?.includes(g));
      const rest = state.mustGoals.filter(g=>!ordered.includes(g));
      ordered = [...(state._priority||[]).filter(x=>state.mustGoals.includes(x)), ...rest];
      state._priority = ordered;

      ordered.forEach((g)=>{
        const it = document.createElement('div');
        it.className = 'item'; it.draggable = true;
        it.innerHTML = '<span class="mono">☰</span> <span>'+g+'</span>';
        it.addEventListener('dragstart', e=>{ it.classList.add('dragging'); e.dataTransfer.setData('text/plain', g); });
        it.addEventListener('dragend', ()=> it.classList.remove('dragging'));
        mount.appendChild(it);
      });
      mount.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const dragging = mount.querySelector('.dragging');
        const after = getDragAfterElement(mount, e.clientY);
        if(!dragging) return;
        if(after == null) mount.appendChild(dragging); else mount.insertBefore(dragging, after);
      });
      mount.addEventListener('drop', ()=>{
        const items = Array.from(mount.querySelectorAll('.item')).map(x=>x.textContent.trim());
        state._priority = items.map(t=>t.replace(/^☰\s*/,'')); updateFundsVisibility(); calcAll();
      });
      function getDragAfterElement(container,y){
        const els=[...container.querySelectorAll('.item:not(.dragging)')];
        return els.reduce((closest,child)=>{
          const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2;
          if(offset<0 && offset>closest.offset) return {offset,element:child}; else return closest;
        },{offset:Number.NEGATIVE_INFINITY}).element;
      }
    }

    // ===== Select sync =====
    function syncMustGoals(){
      const sel = el('must-goals'); sel.innerHTML='';
      state.goals.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sel.appendChild(o); });
      Array.from(sel.options).forEach(o=> o.selected = state.mustGoals.includes(o.value));
    }
    function syncUnmitigable(){
      const sel = el('unmit-select'); sel.innerHTML='';
      state.risks.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
      Array.from(sel.options).forEach(o=> o.selected = state.unmitigable.includes(o.value));
    }

    // ===== Children =====
    const childMax = 6;
    function childRow(idx,data){
      const wrap = document.createElement('div');
      wrap.className='card p-4 mt-3 border border-gray-200';
      wrap.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm text-gray-600 mb-1">Con thứ #${idx+1} - Họ tên</label><input data-k="name" class="form-input" value="${data?.name||''}" placeholder="Tên con"/></div>
          <div><label class="block text-sm text-gray-600 mb-1">Trường dự định</label><input data-k="school" class="form-input" value="${data?.school||''}" placeholder="Tên trường"/></div>
          <div><label class="block text-sm text-gray-600 mb-1">Chi phí 1 năm (₫)</label><input data-k="cost" class="form-input" data-money value="${data?.cost?fmt.format(data.cost):''}" inputmode="numeric" placeholder=""/></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
          <div><label class="block text-sm text-gray-600 mb-1">Số năm học đại học</label><input data-k="years" type="number" min="0" step="1" class="form-input" value="${data?.years||''}"/></div>
          <div class="flex flex-col justify-center"><div class="text-sm text-gray-600">Tổng học phí (#${idx+1})</div><div class="font-bold text-[var(--aia)] mono child-total">₫0</div></div>
          <div class="flex items-center justify-end"><button class="btn btn-ghost border text-red-600" type="button">Xoá</button></div>
        </div>`;
      // bind inputs
      wrap.querySelectorAll('input[data-k]').forEach(inp=>{
        const k = inp.getAttribute('data-k');
        if(k==='cost'){ bindMoneyMask(inp); }
        inp.addEventListener('input', ()=>{
          let v = inp.value;
          if(k==='cost'){ v = Number(digitsOnly(v)||0); }
          if(k==='years'){ v = Number(v||0); }
          state.children[idx][k] = (k==='name'||k==='school') ? v : Number(v||0);
          calcEdu(); calcAll();
        });
      });
      wrap.querySelector('button').onclick = ()=>{ state.children.splice(idx,1); renderChildren(); calcAll(); };
      return wrap;
    }
    function renderChildren(){
      const mount = el('children'); mount.innerHTML='';
      state.children.forEach((c,i)=> mount.appendChild(childRow(i,c)));
      // mask đã gắn trong childRow; chỉ cần tính lại
      calcEdu(); calcAll();
    }

    // ===== Visibility theo ưu tiên =====
    function updateFundsVisibility(){
      const names = (state._priority||[]).map(s=>s.trim().toLowerCase());
      const show = {
        'fund-family': names.includes('vận hành gia đình'),
        'fund-edu': names.includes('quỹ học vấn cho con'),
        'fund-retire': names.includes('quỹ hưu trí'),
        'fund-debt': names.includes('trả nợ'),
        'fund-legacy': names.includes('gia tăng tài sản/ để lại di sản') || names.includes('gia tăng tài sản') || names.includes('để lại di sản')
      };
      Object.entries(show).forEach(([id,on])=>{ const d=el(id); if(d) d.style.display = on?'block':'none'; });
    }

    // ===== Tính toán =====
    function calcFamily(){ const total = getNum('fam-monthly') * 12 * Number(el('fam-years').value||0); el('fam-total').textContent = money(total); return total; }
    function calcEdu(){
      let sum=0;
      state.children.forEach((c,i)=>{
        const t = Number(c.cost||0) * Number(c.years||0); sum += t;
        const mount = el('children').children[i]; if(mount){ const tv = mount.querySelector('.child-total'); if(tv) tv.textContent = money(t); }
      });
      el('edu-total').textContent = money(sum); return sum;
    }
    function calcRetire(){ const xx=Number(el('ret-years').value||0); const yy=getNum('ret-month'); const total=xx*yy*12; el('ret-total').textContent = money(total); return total; }
    const calcDebt = ()=> getNum('debt-amt');
    const calcLegacy = ()=> getNum('legacy-amt');

    function calcAll(){
      const fam = calcFamily();
      const edu = calcEdu();
      const ret = calcRetire();
      const debt = calcDebt();
      const leg = calcLegacy();

      const respItems=[];
      if(el('fund-family').style.display!=='none') respItems.push(['Vận hành gia đình', fam]);
      if(el('fund-edu').style.display!=='none') respItems.push(['Quỹ học vấn cho con', edu]);
      if(el('fund-debt').style.display!=='none') respItems.push(['Thanh khoản các khoản nợ', debt]);
      if(el('fund-legacy').style.display!=='none') respItems.push(['Để lại di sản', leg]);
      el('resp-body').innerHTML = respItems.map(([k,v])=>`<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
      const respSum = respItems.reduce((a,[,v])=>a+Number(v||0),0);
      el('resp-total').textContent = money(respSum);

      const prepared = getNum('resp-prepared');
      el('resp-gap').textContent = money(Math.max(respSum - prepared, 0));

      const saveItems=[];
      if(el('fund-retire').style.display!=='none') saveItems.push(['Quỹ hưu trí', ret]);
      if(el('fund-edu').style.display!=='none') saveItems.push(['Quỹ học vấn cho con', edu]);
      el('save-body').innerHTML = saveItems.map(([k,v])=>`<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
      const saveSum = saveItems.reduce((a,[,v])=>a+Number(v||0),0);
      el('save-total').textContent = money(saveSum);
    }

    // ===== Buttons & events =====
    document.getElementById('add-goal').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.goals, el('goal-input').value); el('goal-input').value=''; render(); });
    document.getElementById('add-reason').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.reasons, el('reason-input').value); el('reason-input').value=''; render(); });
    document.getElementById('add-risk').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.risks, el('risk-input').value); el('risk-input').value=''; render(); });
    document.getElementById('add-alt').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.alts, el('alt-input').value); el('alt-input').value=''; render(); });

    document.getElementById('must-goals').addEventListener('change', ()=>{ const sel=el('must-goals'); state.mustGoals = Array.from(sel.selectedOptions).map(o=>o.value); render(); });
    document.getElementById('unmit-select').addEventListener('change', ()=>{ const sel=el('unmit-select'); state.unmitigable = Array.from(sel.selectedOptions).map(o=>o.value); });

    Array.from(document.querySelectorAll('input[name="partner"]')).forEach(r=>{
      r.addEventListener('change', ()=>{ el('partner-perc-wrap').style.display = (r.value==='yes' && r.checked) ? 'block':'none'; });
    });

    document.getElementById('btn-calc').addEventListener('click', calcAll);
    document.getElementById('btn-preview').addEventListener('click', ()=>{ buildPrint(); el('print-view').classList.remove('hidden'); window.scrollTo(0, el('print-view').offsetTop); });
    document.getElementById('btn-print').addEventListener('click', ()=>{ buildPrint(); window.print(); });
    document.getElementById('btn-print-2').addEventListener('click', ()=>{ buildPrint(); window.print(); });
    document.getElementById('btn-reset').addEventListener('click', ()=>{
      if(!confirm('Xoá toàn bộ dữ liệu đã nhập?')) return;
      Object.assign(state,{goals:[],mustGoals:[],reasons:[],risks:[],unmitigable:[],alts:[],children:[],_priority:[]});
      document.querySelectorAll('input').forEach(i=>{ if(i.type==='radio'){ if(i.value==='no') i.checked=true; } else i.value=''; });
      renderChildren(); render();
    });

    // ===== Print =====
    function buildPrint(){
      const client = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><div class="text-sm text-gray-500">Họ và tên</div><div class="mono">${el('fullname').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Ngày sinh</div><div class="mono">${el('dob').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Nghề nghiệp</div><div class="mono">${el('job').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Phụ thuộc trực tiếp</div><div class="mono">${el('dep-direct').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Phụ thuộc gián tiếp</div><div class="mono">${el('dep-indirect').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Video: Chiếc thuyền (URL)</div><div class="mono">${el('vid-boat').value||''}</div></div>
          <div class="md:col-span-2"><div class="text-sm text-gray-500">Video: Gặp bão (URL)</div><div class="mono">${el('vid-storm').value||''}</div></div>
        </div>`;
      el('print-client').innerHTML = client;

      const goalsHtml = `
        <div><span class="text-gray-600">Tất cả mục tiêu:</span> <span class="font-medium">${state.goals.join(' · ')||'—'}</span></div>
        <div><span class="text-gray-600">Mục tiêu bắt buộc:</span> <span class="font-medium">${state.mustGoals.join(' · ')||'—'}</span></div>
        <div><span class="text-gray-600">Ưu tiên:</span><div class="mt-1">${(state._priority||[]).map((g,i)=>(i+1)+'. '+g).join('<br/>')||'—'}</div></div>
        <hr class="my-2"/>
        <div><span class="text-gray-600">Lý do:</span> <span class="font-medium">${state.reasons.join(' · ')||'—'}</span></div>
        <div><span class="text-gray-600">Yếu tố cản trở:</span> <span class="font-medium">${state.risks.join(' · ')||'—'}</span></div>
        <div><span class="text-gray-600">Không lường trước/khó khắc phục:</span> <span class="font-medium">${state.unmitigable.join(' · ')||'—'}</span></div>
        <div><span class="text-gray-600">Phương án thay thế:</span> <span class="font-medium">${state.alts.join(' · ')||'—'}</span></div>`;
      el('print-goals').innerHTML = goalsHtml;

      calcAll();
      const fundsHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold mb-2">Số tiền trách nhiệm</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Mục</th><th class="py-2 text-right">Số tiền (₫)</th></tr></thead>
              <tbody>${el('resp-body').innerHTML}</tbody>
              <tfoot><tr><td class="py-2 font-semibold">Tổng</td><td class="py-2 text-right font-semibold mono">${el('resp-total').textContent}</td></tr></tfoot>
            </table>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Số tiền phải tích luỹ</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">Mục</th><th class="py-2 text-right">Số tiền (₫)</th></tr></thead>
              <tbody>${el('save-body').innerHTML}</tbody>
              <tfoot><tr><td class="py-2 font-semibold">Tổng</td><td class="py-2 text-right font-semibold mono">${el('save-total').textContent}</td></tr></tfoot>
            </table>
          </div>
        </div>`;
      el('print-funds').innerHTML = fundsHtml;
    }

    // ===== Render init =====
    function render(){
      renderChips(state.goals,'goals'); syncMustGoals();
      renderChips(state.reasons,'reasons');
      renderChips(state.risks,'risks'); syncUnmitigable();
      renderChips(state.alts,'alts');
      buildPriorityList(); updateFundsVisibility(); calcAll();
    }
    // init masks (toàn trang)
    bindAllMoneyMasks(document);
    render();

    // thêm con
    document.getElementById('add-child').addEventListener('click', ()=>{
      if(state.children.length>=childMax) return alert('Tối đa 6 con.');
      state.children.push({name:'',school:'',cost:0,years:0});
      renderChildren();
    });
  </script>
</body>
</html>
