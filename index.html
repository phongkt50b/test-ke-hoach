<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --primary:#2563eb;
      --accent:#10b981;
      --danger:#ef4444;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:linear-gradient(180deg,#eef2ff 0%, #f8fafc 100%);
    }
    header{
      position:sticky; top:0; z-index:999;
      backdrop-filter:saturate(1.1) blur(8px);
      background:rgba(255,255,255,.7);
      border-bottom:1px solid #e5e7eb;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{
      margin:8px 0 0 0;
      font-size:28px; letter-spacing:.3px;
    }
    .sub{color:var(--muted); font-size:14px; margin-top:4px}
    .grid{
      display:grid; gap:18px;
      grid-template-columns: 1.1fr 1fr;
    }
    .card{
      background:var(--card);
      border:1px solid #e5e7eb;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid #eef2f7;
    }
    .card .hd h2{margin:0; font-size:18px}
    .card .bd{padding:16px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], input[type="url"], select, textarea{
      width:100%; padding:10px 12px; font-size:14px;
      border:1px solid #d1d5db; border-radius:10px; outline:none;
      background:#fff;
    }
    textarea{min-height:86px; resize:vertical}
    .hint{font-size:12px; color:var(--muted)}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:10px 14px;
      background:var(--primary); color:#fff; cursor:pointer; font-weight:600;
      box-shadow:0 6px 14px rgba(37,99,235,.2);
    }
    .btn.secondary{background:#111827; box-shadow:0 6px 14px rgba(17,24,39,.15)}
    .btn.ghost{background:transparent; color:var(--primary); border:1px solid #c7d2fe; box-shadow:none}
    .btn.danger{background:var(--danger)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .chip-list{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      background:#eef2ff; color:#374151; border:1px solid #c7d2fe; padding:6px 10px;
      border-radius:999px; font-size:13px; display:inline-flex; align-items:center; gap:8px
    }
    .chip button{border:0; background:transparent; color:#6b7280; cursor:pointer; font-size:16px; line-height:1}
    .muted{color:var(--muted)}
    .divider{height:1px; background:#eef2f7; margin:12px 0}
    .small{font-size:12px}
    .pill{display:inline-block; padding:3px 10px; border-radius:999px; background:#f1f5f9; font-size:12px}
    /* Drag list */
    .dnd{display:flex; gap:8px; flex-direction:column}
    .dnd .item{
      padding:10px 12px; border:1px dashed #cbd5e1; border-radius:10px; background:#fff;
      display:flex; align-items:center; justify-content:space-between; cursor:grab;
    }
    .dnd .item.dragging{opacity:.6}
    .handle{cursor:grab; font-size:18px; color:#64748b}
    /* Two-column summary */
    .summary{
      display:grid; gap:16px; grid-template-columns: 1fr 1fr;
    }
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
    th,td{padding:10px 12px; border-bottom:1px solid #e5e7eb}
    thead th{background:#f8fafc; text-align:left; font-weight:700}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .tag{background:#dbf4ff; color:#0c4a6e; padding:2px 8px; border-radius:10px; font-size:12px}
    .kpi{display:flex; gap:16px; flex-wrap:wrap}
    .kpi .k{
      background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);
      border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; box-shadow:var(--shadow);
      flex:1; min-width:220px
    }
    .k .v{font-size:22px; font-weight:800}
    .k .t{font-size:12px; color:var(--muted)}
    .sticky-actions{
      position:sticky; bottom:0; background:rgba(255,255,255,.85); backdrop-filter:blur(8px);
      border-top:1px solid #e5e7eb; padding:10px; display:flex; gap:10px; justify-content:flex-end
    }
    .note{font-size:12px; color:#475569}
    details summary{cursor:pointer; color:#0f172a; font-weight:600}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    /* Print (A4) */
    @media print{
      header, .sticky-actions, .no-print{display:none !important}
      body{background:white}
      .wrap{padding:0; max-width:800px}
      .card{box-shadow:none; border:0}
      .print-page{page-break-after:always}
      .grid{grid-template-columns: 1fr}
      .summary{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
        <div>
          <h1>üó∫Ô∏è B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n</h1>
          <div class="sub">Thu th·∫≠p th√¥ng tin & t√≠nh nhanh c√°c qu·ªπ m·ª•c ti√™u. C√≥ th·ªÉ in ra PDF ƒë·∫πp.</div>
        </div>
        <div class="actions no-print">
          <button class="btn ghost" id="btn-preview">Xem b·∫£n in</button>
          <button class="btn" id="btn-print">Xu·∫•t PDF</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="grid">
      <!-- LEFT: FORM -->
      <section class="card">
        <div class="hd"><h2>Th√¥ng tin chung</h2><span class="pill">Ph·∫ßn ƒë·∫ßu</span></div>
        <div class="bd">
          <div class="row">
            <div>
              <label>H·ªç v√† t√™n</label>
              <input id="fullname" type="text" placeholder="Nguy·ªÖn VƒÉn A" />
            </div>
            <div>
              <label>Ng√†y sinh</label>
              <input id="dob" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ngh·ªÅ nghi·ªáp</label>
              <input id="job" type="text" placeholder="Chuy√™n vi√™n t√†i ch√≠nh..." />
            </div>
            <div>
              <label>Ng∆∞·ªùi ph·ª• thu·ªôc tr·ª±c ti·∫øp</label>
              <input id="dep-direct" type="text" placeholder="V·ª£/ch·ªìng, con nh·ªè..." />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ng∆∞·ªùi ph·ª• thu·ªôc gi√°n ti·∫øp</label>
              <input id="dep-indirect" type="text" placeholder="B·ªë m·∫π, th√¢n nh√¢n..." />
            </div>
            <div>
              <label>Video 1: Chi·∫øc thuy·ªÅn ra kh∆°i (URL)</label>
              <input id="vid-boat" type="url" placeholder="https://..." />
              <div class="hint">C√≥ th·ªÉ ch√®n video sau. T·∫°m th·ªùi nh·∫≠p URL ƒë·ªÉ l∆∞u l·∫°i.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Video g·∫∑p b√£o</h2><span class="pill">Ph·∫ßn 8</span></div>
        <div class="bd">
          <label>Video 2: ƒêi bi·ªÉn g·∫∑p b√£o (URL)</label>
          <input id="vid-storm" type="url" placeholder="https://..." />
          <div class="hint">Nh·∫≠p URL video minh ho·∫° r·ªßi ro khi kh√¥ng c√≥ k·∫ø ho·∫°ch.</div>
        </div>
      </section>

      <!-- LEFT CONTINUE -->
      <section class="card">
        <div class="hd"><h2>M·ª•c ti√™u/K·∫ø ho·∫°ch</h2><span class="pill">Ph·∫ßn 2 & 3</span></div>
        <div class="bd">
          <div>
            <label>Th√™m m·ª•c ti√™u (g·ª£i √Ω ph√≠a d∆∞·ªõi)</label>
            <div class="row">
              <div>
                <input id="goal-input" list="goal-suggest" placeholder="V√≠ d·ª•: V·∫≠n h√†nh gia ƒë√¨nh" />
                <datalist id="goal-suggest">
                  <option value="V·∫≠n h√†nh gia ƒë√¨nh"></option>
                  <option value="Qu·ªπ h·ªçc v·∫•n cho con"></option>
                  <option value="Qu·ªπ h∆∞u tr√≠"></option>
                  <option value="Tr·∫£ n·ª£"></option>
                  <option value="Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n"></option>
                  <option value="M·ªü doanh nghi·ªáp ri√™ng"></option>
                </datalist>
              </div>
              <div class="actions">
                <button class="btn" id="add-goal">Th√™m m·ª•c ti√™u</button>
              </div>
            </div>
            <div class="chip-list" id="goals"></div>
            <div class="divider"></div>
          </div>

          <div>
            <label>Nh·ªØng m·ª•c ti√™u b·∫Øt bu·ªôc ph·∫£i l√†m b·∫±ng m·ªçi gi√° (ch·ªçn nhi·ªÅu)</label>
            <select id="must-goals" multiple size="6" style="width:100%"></select>
            <div class="hint small">Gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu.</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>L√Ω do b·∫Øt bu·ªôc</h2><span class="pill">Ph·∫ßn 4</span></div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Th√™m l√Ω do</label>
              <input id="reason-input" type="text" placeholder="V√≠ d·ª•: B·∫£o v·ªá con c√°i tr∆∞·ªõc r·ªßi ro" />
            </div>
            <div class="actions">
              <button class="btn" id="add-reason">Th√™m l√Ω do</button>
            </div>
          </div>
          <div class="chip-list" id="reasons"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>∆Øu ti√™n m·ª•c ti√™u</h2><span class="pill">Ph·∫ßn 5</span></div>
        <div class="bd">
          <div class="hint">K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp t·ª´ quan tr·ªçng nh·∫•t (tr√™n) t·ªõi √≠t quan tr·ªçng nh·∫•t (d∆∞·ªõi). Danh s√°ch l·∫•y t·ª´ m·ª•c 3.</div>
          <div class="dnd" id="priority-list"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Th√†nh vi√™n c√πng th·ª±c hi·ªán & Th·ªùi h·∫°n</h2><span class="pill">Ph·∫ßn 6 & 7</span></div>
        <div class="bd">
          <div class="row">
            <div>
              <label>C√≥ ai c√πng th·ª±c hi·ªán m·ª•c ti√™u kh√¥ng?</label>
              <div style="display:flex; gap:10px; align-items:center">
                <label><input type="radio" name="partner" value="no" checked/> Kh√¥ng</label>
                <label><input type="radio" name="partner" value="yes"/> C√≥</label>
              </div>
            </div>
            <div id="partner-perc-wrap" style="display:none">
              <label>Anh/ch·ªã ƒë√≥ng g√≥p % c√¥ng s·ª©c</label>
              <input id="partner-perc" type="number" min="0" max="100" step="1" placeholder="%" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>D·ª± ƒë·ªãnh ho√†n th√†nh t·∫•t c·∫£ m·ª•c ti√™u trong bao l√¢u (nƒÉm)?</label>
              <input id="years-all" type="number" min="0" step="1" placeholder="S·ªë nƒÉm" />
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>R√†o c·∫£n & Ph∆∞∆°ng √°n</h2><span class="pill">Ph·∫ßn 9‚Äì11</span></div>
        <div class="bd">
          <details open>
            <summary>9) Y·∫øu t·ªë khi·∫øn kh√¥ng ƒë·∫°t m·ª•c ti√™u</summary>
            <div class="row" style="margin-top:8px">
              <div>
                <label>Th√™m y·∫øu t·ªë</label>
                <input id="risk-input" type="text" placeholder="V√≠ d·ª•: ·ªêm ƒëau, th·∫•t nghi·ªáp..." />
              </div>
              <div class="actions">
                <button class="btn" id="add-risk">Th√™m y·∫øu t·ªë</button>
              </div>
            </div>
            <div class="chip-list" id="risks"></div>
          </details>
          <div class="divider"></div>
          <details open>
            <summary>10) Y·∫øu t·ªë kh√¥ng th·ªÉ l∆∞·ªùng tr∆∞·ªõc & kh√¥ng th·ªÉ kh·∫Øc ph·ª•c (ch·ªçn nhi·ªÅu)</summary>
            <select id="unmit-select" multiple size="6" style="width:100%"></select>
            <div class="hint small">Ch·ªçn c√°c y·∫øu t·ªë t·ª´ danh s√°ch tr√™n.</div>
          </details>
          <div class="divider"></div>
          <details open>
            <summary>11) Ph∆∞∆°ng √°n thay th·∫ø</summary>
            <div class="row" style="margin-top:8px">
              <div>
                <label>Th√™m ph∆∞∆°ng √°n</label>
                <input id="alt-input" type="text" placeholder="V√≠ d·ª•: D·ª± ph√≤ng 12 th√°ng chi ti√™u..." />
              </div>
              <div class="actions">
                <button class="btn" id="add-alt">Th√™m ph∆∞∆°ng √°n</button>
              </div>
            </div>
            <div class="chip-list" id="alts"></div>
          </details>
        </div>
      </section>

      <!-- RIGHT: FUNDS -->
      <section class="card">
        <div class="hd"><h2>12) C√°c qu·ªπ c·∫ßn thi·∫øt</h2><span class="pill">T·ª± ƒë·ªông hi·ªÉn th·ªã theo ∆∞u ti√™n</span></div>
        <div class="bd" id="funds">
          <details open id="fund-family" data-match="V·∫≠n h√†nh gia ƒë√¨nh">
            <summary>V·∫≠n h√†nh gia ƒë√¨nh</summary>
            <div class="row">
              <div>
                <label>Chi ph√≠ thi·∫øt y·∫øu / th√°ng (‚Ç´)</label>
                <input id="fam-monthly" type="number" min="0" step="1000" placeholder="XX" />
              </div>
              <div>
                <label>Trang tr·∫£i t·ªëi thi·ªÉu trong (nƒÉm)</label>
                <input id="fam-years" type="number" min="0" step="1" placeholder="YY" />
              </div>
            </div>
            <div class="kpi" style="margin-top:10px">
              <div class="k"><div class="t">Qu·ªπ v·∫≠n h√†nh gia ƒë√¨nh c·∫ßn c√≥</div><div class="v mono" id="fam-total">‚Ç´0</div></div>
            </div>
          </details>

          <details id="fund-edu" data-match="Qu·ªπ h·ªçc v·∫•n cho con">
            <summary>Qu·ªπ h·ªçc v·∫•n ƒë·∫°i h·ªçc cho con</summary>
            <div id="children"></div>
            <div class="actions" style="margin-top:8px">
              <button class="btn" id="add-child">Th√™m con</button>
              <span class="note">T·ªëi ƒëa 6 con.</span>
            </div>
            <div class="kpi" style="margin-top:10px">
              <div class="k"><div class="t">T·ªïng qu·ªπ h·ªçc v·∫•n</div><div class="v mono" id="edu-total">‚Ç´0</div></div>
            </div>
          </details>

          <details id="fund-retire" data-match="Qu·ªπ h∆∞u tr√≠">
            <summary>Qu·ªπ h∆∞u tr√≠</summary>
            <div class="row-3">
              <div>
                <label>Tu·ªïi ngh·ªâ h∆∞u</label>
                <input id="ret-age" type="number" min="0" step="1" />
              </div>
              <div>
                <label>S·ªëng an nh√†n trong (nƒÉm) ‚Äì xx</label>
                <input id="ret-years" type="number" min="0" step="1" />
              </div>
              <div>
                <label>Chi ti√™u c√° nh√¢n / th√°ng ‚Äì yy (‚Ç´)</label>
                <input id="ret-month" type="number" min="0" step="1000" />
              </div>
            </div>
            <div class="kpi" style="margin-top:10px">
              <div class="k"><div class="t">T·ªïng qu·ªπ h∆∞u tr√≠ = xx √ó yy √ó 12</div><div class="v mono" id="ret-total">‚Ç´0</div></div>
            </div>
          </details>

          <details id="fund-debt" data-match="Tr·∫£ n·ª£">
            <summary>Thanh kho·∫£n c√°c kho·∫£n n·ª£</summary>
            <div class="row">
              <div>
                <label>Kho·∫£n n·ª£ hi·ªán t·∫°i (‚Ç´)</label>
                <input id="debt-amt" type="number" min="0" step="1000" />
              </div>
              <div>
                <label>Th·ªùi h·∫°n c·∫ßn tr·∫£ (nƒÉm)</label>
                <input id="debt-years" type="number" min="0" step="1" />
              </div>
            </div>
          </details>

          <details id="fund-legacy" data-match="Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n">
            <summary>Gia tƒÉng t√†i s·∫£n / ƒê·ªÉ l·∫°i di s·∫£n</summary>
            <div class="row">
              <div>
                <label>Gi√° tr·ªã t√†i s·∫£n k·ª≥ v·ªçng (‚Ç´)</label>
                <input id="legacy-amt" type="number" min="0" step="1000" />
              </div>
              <div>
                <label>Th·ªùi gian d·ª± ki·∫øn (nƒÉm)</label>
                <input id="legacy-years" type="number" min="0" step="1" />
              </div>
            </div>
          </details>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>T·ªïng h·ª£p qu·ªπ tr√°ch nhi·ªám</h2><span class="pill">N√∫t t·ªïng k·∫øt</span></div>
        <div class="bd">
          <div class="actions" style="margin-bottom:10px">
            <button class="btn secondary" id="btn-calc">C·∫≠p nh·∫≠t t·ªïng h·ª£p</button>
          </div>
          <div class="summary">
            <div>
              <h3>S·ªë ti·ªÅn tr√°ch nhi·ªám ‚Äì <span class="tag">c·∫ßn lu√¥n s·∫µn s√†ng</span></h3>
              <table>
                <thead><tr><th>M·ª•c</th><th class="right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="resp-body"></tbody>
                <tfoot><tr><td>T·ªïng</td><td class="right mono" id="resp-total">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="row" style="margin-top:10px">
                <div>
                  <label>S·ªë ti·ªÅn tr√°ch nhi·ªám ƒë√£ chu·∫©n b·ªã (‚Ç´)</label>
                  <input id="resp-prepared" type="number" min="0" step="1000" />
                </div>
                <div class="k kpi"><div class="t">Kho·∫£ng thi·∫øu (∆∞·ªõc t√≠nh)</div><div class="v mono" id="resp-gap">‚Ç´0</div></div>
              </div>
            </div>
            <div>
              <h3>S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ ‚Äì <span class="tag">d√πng trong t∆∞∆°ng lai</span></h3>
              <table>
                <thead><tr><th>M·ª•c</th><th class="right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="save-body"></tbody>
                <tfoot><tr><td>T·ªïng</td><td class="right mono" id="save-total">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="row" style="margin-top:10px">
                <div>
                  <label>Mong mu·ªën ho√†n th√†nh (%)</label>
                  <input id="goal-percent" type="number" min="0" max="100" step="1" placeholder="%" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="sticky-actions no-print">
      <span class="muted">üí° Tip: Nh·∫•n <b>Xem b·∫£n in</b> ƒë·ªÉ xem PDF tr∆∞·ªõc khi xu·∫•t.</span>
      <span style="flex:1"></span>
      <button class="btn ghost" id="btn-reset">Xo√° d·ªØ li·ªáu</button>
      <button class="btn" id="btn-print-2">Xu·∫•t PDF</button>
    </div>
  </main>

  <!-- PRINT PREVIEW CONTAINER (hidden until needed) -->
  <section id="print-view" class="wrap" style="display:none">
    <div class="card print-page">
      <div class="hd"><h2>T√≥m t·∫Øt kh√°ch h√†ng</h2><span class="pill">B·∫£n in</span></div>
      <div class="bd" id="print-client"></div>
    </div>
    <div class="card print-page">
      <div class="hd"><h2>M·ª•c ti√™u & ∆Øu ti√™n</h2></div>
      <div class="bd" id="print-goals"></div>
    </div>
    <div class="card print-page">
      <div class="hd"><h2>C√°c qu·ªπ & T·ªïng h·ª£p</h2></div>
      <div class="bd" id="print-funds"></div>
    </div>
  </section>

  <script>
  // --------- Utilities ---------
  const fmt = new Intl.NumberFormat('vi-VN');
  const el = id => document.getElementById(id);
  const money = v => '‚Ç´' + fmt.format(Number(v||0));

  const state = {
    goals: [],        // list of all goals (strings)
    mustGoals: [],    // selected from goals (strings)
    reasons: [],
    risks: [],
    unmitigable: [],
    alts: [],
    children: []      // {name, school, cost, years}
  };

  function renderChips(arr, mountId){
    const mount = el(mountId);
    mount.innerHTML = '';
    arr.forEach((txt, i)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = '<span>'+txt+'</span><button title="X√≥a" data-i="'+i+'">√ó</button>';
      chip.querySelector('button').onclick = ()=>{ arr.splice(i,1); render(); };
      mount.appendChild(chip);
    });
  }

  function uniquePush(arr, item){
    const s = item.trim();
    if(!s) return;
    if(!arr.includes(s)) arr.push(s);
  }

  function syncMustGoals(){
    const sel = el('must-goals');
    sel.innerHTML = '';
    state.goals.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g; opt.textContent = g;
      sel.appendChild(opt);
    });
    // re-apply selections
    Array.from(sel.options).forEach(op=> op.selected = state.mustGoals.includes(op.value));
  }

  function syncUnmitigable(){
    const sel = el('unmit-select');
    sel.innerHTML = '';
    state.risks.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r;
      sel.appendChild(opt);
    });
    Array.from(sel.options).forEach(op=> op.selected = state.unmitigable.includes(op.value));
  }

  function buildPriorityList(){
    const mount = el('priority-list');
    mount.innerHTML='';
    // ensure items == mustGoals (in order of existing priority if possible)
    let ordered = state.mustGoals.filter(g=>state._priority?.includes(g));
    const rest = state.mustGoals.filter(g=>!ordered.includes(g));
    ordered = [...(state._priority||[]).filter(x=>state.mustGoals.includes(x)), ...rest];
    state._priority = ordered;

    ordered.forEach((g)=>{
      const it = document.createElement('div');
      it.className = 'item';
      it.draggable = true;
      it.innerHTML = '<span class="mono">‚ò∞</span> <span>'+g+'</span>';
      it.querySelector('span').className='handle';

      it.addEventListener('dragstart', e=>{
        it.classList.add('dragging');
        e.dataTransfer.setData('text/plain', g);
      });
      it.addEventListener('dragend', ()=> it.classList.remove('dragging'));

      mount.appendChild(it);
    });

    mount.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const dragging = mount.querySelector('.dragging');
      const after = getDragAfterElement(mount, e.clientY);
      if(after == null) mount.appendChild(dragging);
      else mount.insertBefore(dragging, after);
    });

    mount.addEventListener('drop', ()=>{
      const items = Array.from(mount.querySelectorAll('.item')).map(x=>x.textContent.trim());
      // textContent includes handle icon; clean it:
      state._priority = items.map(t=> t.replace(/^‚ò∞\s*/,''));
      updateFundsVisibility();
    });

    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.item:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if(offset < 0 && offset > closest.offset) return {offset, element: child};
        else return closest;
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }
  }

  function render(){
    renderChips(state.goals, 'goals');
    syncMustGoals();
    renderChips(state.reasons, 'reasons');
    renderChips(state.risks, 'risks');
    syncUnmitigable();
    renderChips(state.alts, 'alts');
    buildPriorityList();
    updateFundsVisibility();
    calcAll();
  }

  // --------- Events for adding items ---------
  el('add-goal').onclick = ()=>{ uniquePush(state.goals, el('goal-input').value); el('goal-input').value=''; render(); };
  el('add-reason').onclick = ()=>{ uniquePush(state.reasons, el('reason-input').value); el('reason-input').value=''; render(); };
  el('add-risk').onclick = ()=>{ uniquePush(state.risks, el('risk-input').value); el('risk-input').value=''; render(); };
  el('add-alt').onclick = ()=>{ uniquePush(state.alts, el('alt-input').value); el('alt-input').value=''; render(); };

  el('must-goals').addEventListener('change', ()=>{
    const sel = el('must-goals');
    state.mustGoals = Array.from(sel.selectedOptions).map(o=>o.value);
    render();
  });

  el('unmit-select').addEventListener('change', ()=>{
    const sel = el('unmit-select');
    state.unmitigable = Array.from(sel.selectedOptions).map(o=>o.value);
  });

  // partner % visibility
  Array.from(document.querySelectorAll('input[name="partner"]')).forEach(r=>{
    r.addEventListener('change', ()=>{
      el('partner-perc-wrap').style.display = (r.value==='yes' && r.checked) ? 'block' : 'none';
    });
  });

  // --------- Funds calc & visibility ---------
  function goalMatchName(txt){
    return (txt||'').trim().toLowerCase();
  }
  const NAME_FAMILY = goalMatchName('V·∫≠n h√†nh gia ƒë√¨nh');
  const NAME_EDU = goalMatchName('Qu·ªπ h·ªçc v·∫•n cho con');
  const NAME_RET = goalMatchName('Qu·ªπ h∆∞u tr√≠');
  const NAME_DEBT = goalMatchName('Tr·∫£ n·ª£');
  const NAME_LEG = goalMatchName('Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n');

  function updateFundsVisibility(){
    // show details if the prioritized goals include the matched ones
    const pr = (state._priority||[]).map(goalMatchName);
    const map = {
      'fund-family': pr.includes(NAME_FAMILY),
      'fund-edu': pr.includes(NAME_EDU),
      'fund-retire': pr.includes(NAME_RET),
      'fund-debt': pr.includes(NAME_DEBT),
      'fund-legacy': pr.includes(NAME_LEG),
    };
    Object.entries(map).forEach(([id, show])=>{
      const d = el(id);
      if(!d) return;
      d.style.display = show ? 'block' : 'none';
    });
  }

  // children component
  const childMax = 6;
  function childRow(idx, data){
    const wrap = document.createElement('div');
    wrap.className='card';
    wrap.style.marginTop='10px';
    wrap.innerHTML = `
      <div class="bd">
        <div class="row-3">
          <div><label>Con th·ª© #${idx+1} - H·ªç t√™n</label><input data-k="name" type="text" value="${data?.name||''}" placeholder="T√™n con"/></div>
          <div><label>Tr∆∞·ªùng d·ª± ƒë·ªãnh</label><input data-k="school" type="text" value="${data?.school||''}" placeholder="T√™n tr∆∞·ªùng"/></div>
          <div><label>Chi ph√≠ 1 nƒÉm (‚Ç´)</label><input data-k="cost" type="number" min="0" step="1000" value="${data?.cost||''}"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label>S·ªë nƒÉm h·ªçc ƒë·∫°i h·ªçc</label><input data-k="years" type="number" min="0" step="1" value="${data?.years||''}"/></div>
          <div class="k kpi"><div class="t">T·ªïng h·ªçc ph√≠ (#${idx+1})</div><div class="v mono child-total">‚Ç´0</div></div>
          <div class="actions"><button class="btn danger">Xo√°</button></div>
        </div>
      </div>`;
    const inputs = wrap.querySelectorAll('input[data-k]');
    inputs.forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const k = inp.getAttribute('data-k');
        state.children[idx][k] = inp.type==='number' ? Number(inp.value||0) : inp.value;
        calcEdu();
      });
    });
    wrap.querySelector('.btn.danger').onclick = ()=>{
      state.children.splice(idx,1);
      renderChildren();
    };
    return wrap;
  }
  function renderChildren(){
    const mount = el('children');
    mount.innerHTML='';
    state.children.forEach((c,i)=> mount.appendChild(childRow(i,c)));
    calcEdu();
  }

  el('add-child').onclick = ()=>{
    if(state.children.length >= childMax){ alert('T·ªëi ƒëa 6 con.'); return; }
    state.children.push({name:'', school:'', cost:0, years:0});
    renderChildren();
  };

  function calcFamily(){
    const monthly = Number(el('fam-monthly').value||0);
    const years = Number(el('fam-years').value||0);
    const total = monthly * 12 * years;
    el('fam-total').textContent = money(total);
    return total;
  }

  function calcEdu(){
    let sum = 0;
    state.children.forEach((c, i)=>{
      const t = Number(c.cost||0) * Number(c.years||0);
      sum += t;
      // update UI row total
      const mount = el('children').children[i];
      if(mount){
        const tv = mount.querySelector('.child-total');
        if(tv) tv.textContent = money(t);
      }
    });
    el('edu-total').textContent = money(sum);
    return sum;
  }

  function calcRetire(){
    const xx = Number(el('ret-years').value||0);
    const yy = Number(el('ret-month').value||0);
    const total = xx * yy * 12;
    el('ret-total').textContent = money(total);
    return total;
  }

  function calcDebt(){
    return Number(el('debt-amt').value||0);
  }
  function calcLegacy(){
    return Number(el('legacy-amt').value||0);
  }

  function calcAll(){
    const fam = calcFamily();
    const edu = calcEdu();
    const ret = calcRetire();
    const debt = calcDebt();
    const leg = calcLegacy();

    // Left column (Responsibility): family + education + debt + legacy
    const respItems = [];
    if(el('fund-family').style.display!=='none') respItems.push(['V·∫≠n h√†nh gia ƒë√¨nh', fam]);
    if(el('fund-edu').style.display!=='none') respItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
    if(el('fund-debt').style.display!=='none') respItems.push(['Thanh kho·∫£n c√°c kho·∫£n n·ª£', debt]);
    if(el('fund-legacy').style.display!=='none') respItems.push(['ƒê·ªÉ l·∫°i di s·∫£n', leg]);
    const respBody = el('resp-body');
    respBody.innerHTML = respItems.map(([k,v])=> `<tr><td>${k}</td><td class="right mono">${money(v)}</td></tr>`).join('');
    const respSum = respItems.reduce((a, [,v])=>a+Number(v||0), 0);
    el('resp-total').textContent = money(respSum);

    const prepared = Number(el('resp-prepared').value||0);
    el('resp-gap').textContent = money(Math.max(respSum - prepared, 0));

    // Right column (Savings): retirement + education
    const saveItems = [];
    if(el('fund-retire').style.display!=='none') saveItems.push(['Qu·ªπ h∆∞u tr√≠', ret]);
    if(el('fund-edu').style.display!=='none') saveItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
    const saveBody = el('save-body');
    saveBody.innerHTML = saveItems.map(([k,v])=> `<tr><td>${k}</td><td class="right mono">${money(v)}</td></tr>`).join('');
    const saveSum = saveItems.reduce((a, [,v])=>a+Number(v||0), 0);
    el('save-total').textContent = money(saveSum);
  }

  // recalc on inputs
  ['fam-monthly','fam-years','ret-years','ret-month','debt-amt','legacy-amt','resp-prepared']
    .forEach(id=> el(id).addEventListener('input', calcAll));

  // button calc
  el('btn-calc').onclick = calcAll;

  // --------- Print Preview ---------
  function buildPrint(){
    // 1) client
    const client = `
      <div class="row">
        <div><label>H·ªç v√† t√™n</label><div class="mono">${el('fullname').value||''}</div></div>
        <div><label>Ng√†y sinh</label><div class="mono">${el('dob').value||''}</div></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Ngh·ªÅ nghi·ªáp</label><div class="mono">${el('job').value||''}</div></div>
        <div><label>Ph·ª• thu·ªôc tr·ª±c ti·∫øp</label><div class="mono">${el('dep-direct').value||''}</div></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Ph·ª• thu·ªôc gi√°n ti·∫øp</label><div class="mono">${el('dep-indirect').value||''}</div></div>
        <div><label>Video: Chi·∫øc thuy·ªÅn (URL)</label><div class="mono">${el('vid-boat').value||''}</div></div>
      </div>
      <div style="margin-top:8px"><label>Video: G·∫∑p b√£o (URL)</label><div class="mono">${el('vid-storm').value||''}</div></div>
    `;
    el('print-client').innerHTML = client;

    // 2) goals & reasons
    const goalsHtml = `
      <div><label>T·∫•t c·∫£ m·ª•c ti√™u</label><div class="mono">${state.goals.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div style="margin-top:8px"><label>M·ª•c ti√™u b·∫Øt bu·ªôc</label><div class="mono">${state.mustGoals.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div style="margin-top:8px"><label>∆Øu ti√™n</label><div class="mono">${(state._priority||[]).map((g,i)=> (i+1)+'. '+g).join('<br/>') || '‚Äî'}</div></div>
      <div class="divider"></div>
      <div><label>L√Ω do</label><div class="mono">${state.reasons.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div style="margin-top:8px"><label>Y·∫øu t·ªë c·∫£n tr·ªü</label><div class="mono">${state.risks.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div style="margin-top:8px"><label>Kh√¥ng l∆∞·ªùng tr∆∞·ªõc/kh√≥ kh·∫Øc ph·ª•c</label><div class="mono">${state.unmitigable.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div style="margin-top:8px"><label>Ph∆∞∆°ng √°n thay th·∫ø</label><div class="mono">${state.alts.join(' ¬∑ ')||'‚Äî'}</div></div>
      <div class="divider"></div>
      <div class="row">
        <div><label>C√≥ ƒë·ªìng h√†nh</label><div class="mono">${document.querySelector('input[name="partner"]:checked')?.value==='yes'?'C√≥':'Kh√¥ng'}</div></div>
        <div><label>% ƒë√≥ng g√≥p</label><div class="mono">${el('partner-perc').value||'‚Äî'}</div></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Th·ªùi gian ho√†n th√†nh (nƒÉm)</label><div class="mono">${el('years-all').value||'‚Äî'}</div></div>
      </div>
    `;
    el('print-goals').innerHTML = goalsHtml;

    // 3) funds & totals
    calcAll(); // ensure fresh
    const fundsHtml = `
      <div class="summary">
        <div>
          <h3>S·ªë ti·ªÅn tr√°ch nhi·ªám</h3>
          <table>${el('resp-body').parentElement.outerHTML}</table>
        </div>
        <div>
          <h3>S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ</h3>
          <table>${el('save-body').parentElement.outerHTML}</table>
        </div>
      </div>
    `;
    el('print-funds').innerHTML = fundsHtml;
  }

  el('btn-preview').onclick = ()=>{
    buildPrint();
    document.querySelector('main').style.display='none';
    el('print-view').style.display='block';
    window.scrollTo(0,0);
  };
  function exitPreview(){
    el('print-view').style.display='none';
    document.querySelector('main').style.display='block';
  }

  el('btn-print').onclick = ()=>{ buildPrint(); window.print(); };
  el('btn-print-2').onclick = ()=>{ buildPrint(); window.print(); };

  // reset
  el('btn-reset').onclick = ()=>{
    if(!confirm('Xo√° to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) return;
    Object.assign(state, {goals:[], mustGoals:[], reasons:[], risks:[], unmitigable:[], alts:[], children:[]});
    document.querySelectorAll('input').forEach(i=>{
      if(i.type==='radio'){ if(i.value==='no') i.checked=true; }
      else i.value='';
    });
    renderChildren();
    render();
  };

  // init
  render();
  </script>
</body>
</html>
