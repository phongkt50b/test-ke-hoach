<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Bản đồ tài chính cá nhân - Lập kế hoạch tài chính thông minh</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Công cụ lập bản đồ tài chính cá nhân: xác định mục tiêu, yếu tố ảnh hưởng và tổng hợp kế hoạch." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css" />
  <style>
    html,body {font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;}
    ::selection { background:#4338ca; color:#fff; }
    .font-script { font-family:'Pacifico',cursive; }
    .glass { background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.25); backdrop-filter:blur(10px); }
    .section-card { background:#fff; border:1px solid #e2e8f0; border-radius:1.25rem; padding:2rem; }
    @media (min-width:768px){ .section-card { padding:2.5rem; } }
    .sub-box { background:#f8fafc; border:1px solid #e2e8f0; border-radius:1rem; padding:1.25rem 1.25rem 1rem; }
    .priority-item {
      position:relative; display:flex; align-items:center; gap:.75rem;
      background:#ffffff; border:1px solid #e2e8f0; border-radius:1rem;
      padding:.85rem 1rem; font-size:.85rem; font-weight:500;
      cursor:pointer; transition:.25s; box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .priority-item:hover { box-shadow:0 4px 10px -2px rgba(0,0,0,.08); }
    .priority-item.selected {
      background:linear-gradient(90deg,#2563eb,#7c3aed);
      border-color:transparent; color:#fff; box-shadow:0 6px 16px -4px rgba(37,99,235,.4);
    }
    .priority-item button.remove-goal {
      background:#e2e8f0; border:none; font-size:.7rem; padding:.25rem .5rem;
      border-radius:.4rem; cursor:pointer; font-weight:600; color:#334155; transition:.25s;
    }
    .priority-item button.remove-goal:hover { background:#f87171; color:#fff; }
    .priority-item.selected button.remove-goal { background:rgba(255,255,255,.25); color:#fff; }
    .priority-item.selected button.remove-goal:hover { background:#ef4444; }
    .chip {
      display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .75rem .3rem;
      font-size:.75rem; font-weight:500; background:linear-gradient(135deg,#f1f5f9,#ffffff);
      border:1px solid #e2e8f0; color:#334155; border-radius:999px; line-height:1;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .chip button { background:transparent; border:none; cursor:pointer; font-size:1rem; line-height:1; color:#64748b; padding:0; margin:0; }
    .chip button:hover { color:#ef4444; }
    .chip-positive { background:linear-gradient(135deg,#dcfce7,#f0fdf4); border-color:#bbf7d0; color:#166534; }
    .chip-negative { background:linear-gradient(135deg,#fee2e2,#fff1f1); border-color:#fecaca; color:#991b1b; }
    .chip-alt { background:linear-gradient(135deg,#ede9fe,#faf5ff); border-color:#ddd6fe; color:#5b21b6; }
    .child-card {
      background:#fff; border:1px solid #e2e8f0; border-radius:1rem; padding:1rem 1rem .75rem; position:relative;
    }
    .child-card::before {
      content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
      background:linear-gradient(#2563eb,#7c3aed); border-top-left-radius:1rem; border-bottom-left-radius:1rem;
    }
    .formula {
      font-family: inherit;
      font-size: inherit;
      color: #475569; /* slate-600, for subtle emphasis */
      display:inline-block;
      margin-top:2px;
    }
    .summary-card {
      background:#fff; border:1px solid #e2e8f0; border-radius:1rem; padding:1.25rem 1.25rem 1rem;
      display:flex; flex-direction:column; gap:.75rem; box-shadow:0 2px 4px rgba(0,0,0,.04);
    }
    .progress-ring { transition:stroke-dashoffset .6s cubic-bezier(.4,0,.2,1); }
    input[data-money].editing { background:#fff7ed; }
    @media print {
      .no-print, header, footer, #goals, #factors { display:none !important; }
      body { background:#fff; }
      main { padding-top: 0; }
      #summary { border: none; box-shadow: none; padding: 0; }
      section, .summary-card, .child-card { 
        break-inside:avoid;
        box-shadow: none;
      }
      #summary > div:first-child > h2::before {
        content: "Bản đồ tài chính cá nhân";
        display: block;
        text-align: center;
        font-size: 1rem;
        font-weight: normal;
        color: #64748b;
        margin-bottom: 0.5rem;
      }
      #summary > div:first-child > h2 {
        text-align: center;
        width: 100%;
      }
    }
    .fade-in { animation:fade .5s ease; }
    @keyframes fade { from {opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }
  </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.20.0",
    "marked": "https://aistudiocdn.com/marked@^16.3.0"
  }
}
</script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 text-slate-800 antialiased">

  <!-- Hero -->
  <section class="relative overflow-hidden no-print">
    <div class="absolute inset-0" style="background-color: #d4002a;"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_40%,rgba(255,255,255,0.25),transparent_60%)]"></div>
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 lg:py-28">
      <div class="grid lg:grid-cols-2 gap-14 items-center">
        <div class="text-white space-y-8">
          <div class="space-y-4">
            <h1 class="text-4xl lg:text-6xl font-bold leading-tight">
              Xây dựng
              <span class="block text-yellow-300">Tương lai tài chính</span>
              của bạn
            </h1>
            <p class="text-xl lg:text-2xl text-red-100 leading-relaxed">
              Lập kế hoạch rõ ràng, đo tiến độ và ra quyết định tự tin — miễn phí & trực quan.
            </p>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="document.querySelector('#goals').scrollIntoView({behavior:'smooth'})"
              class="bg-yellow-400 text-red-900 px-8 py-4 rounded-xl font-semibold text-lg hover:bg-yellow-300 transition shadow-lg hover:scale-[1.03]">
              Bắt đầu ngay
            </button>
            <button onclick="document.querySelector('#factors').scrollIntoView({behavior:'smooth'})"
              class="border-2 border-white text-white px-8 py-4 rounded-xl font-semibold text-lg hover:bg-white hover:text-red-700 transition">
              Tìm hiểu thêm
            </button>
          </div>
          <div class="flex flex-wrap items-center gap-6 text-red-100 text-sm">
            <div class="flex items-center gap-2">
              <i class="ri-shield-check-line text-2xl text-yellow-300"></i><span>Miễn phí</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="ri-user-heart-line text-2xl text-yellow-300"></i><span>Dễ dùng</span>
            </div>
            <div class="flex items-center gap-2">
              <i class="ri-lock-line text-2xl text-yellow-300"></i><span>Lưu cục bộ</span>
            </div>
          </div>
        </div>
        <div class="relative">
          <div class="glass rounded-2xl p-6 lg:p-8 shadow-2xl">
            <div class="aspect-video rounded-xl overflow-hidden shadow-lg border border-white/30 bg-black/40">
              <iframe
                class="w-full h-full object-cover"
                src="https://www.youtube.com/embed/WbGeIDKdrdo?autoplay=0&mute=1&rel=0"
                title="Video giới thiệu"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
            </div>
            <p class="text-center text-red-100 mt-4 text-sm">Video hướng dẫn</p>
          </div>
        </div>
      </div>
    </div>
    <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-white/20 to-transparent pointer-events-none"></div>
  </section>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-14">

    <!-- GOALS -->
    <section id="goals" class="section-card fade-in">
      <div class="flex items-center gap-3 mb-8">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center text-white">
          <i class="ri-target-line text-xl"></i>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold">Phần 1: Làm rõ mục tiêu tài chính</h2>
      </div>

      <div class="space-y-8">
        <!-- 1 -->
          <div class="sub-box">
          <label class="block text-lg font-semibold mb-4">1. Mục tiêu/Kế hoạch dài hạn</label>
          <div class="flex flex-col sm:flex-row gap-3 mb-3">
            <input id="goal-input" list="goal-suggestions" placeholder="Nhập mục tiêu..."
              class="flex-1 px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            <datalist id="goal-suggestions">
              <option value="Vận hành gia đình" />
              <option value="Quỹ học vấn cho con" />
              <option value="Quỹ hưu trí" />
              <option value="Trả nợ" />
              <option value="Gia tăng tài sản/ Để lại di sản" />
            
            </datalist>
            <button id="add-goal" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-blue-700 transition">+ Thêm</button>
          </div>
          <p class="text-slate-500 text-sm mb-4">Bấm vào thẻ để đánh dấu mục tiêu quan trọng. Nhấn × để xoá.</p>
          <div id="priority-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- 2 -->
        <div class="sub-box">
          <label class="block text-lg font-semibold mb-4">2. Mục tiêu quan trọng nhất</label>
          <div id="must-list" class="flex flex-wrap gap-2 min-h-[2.2rem]"></div>
        </div>

        <!-- 3 -->
        <div class="sub-box">
          <label class="block text-lg font-semibold mb-4">3. Lý do</label>
          <div class="flex flex-col sm:flex-row gap-3 mb-3">
            <input id="reason-input" placeholder="Nhập lý do..."
              class="flex-1 px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm">
            <button id="add-reason" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-blue-700 transition">+ Thêm</button>
          </div>
          <div id="reasons" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- 4. Partner and Time -->
        <div class="sub-box">
          <label class="block text-lg font-semibold mb-4">4. Người đồng hành và thời hạn hoàn thành</label>
          <div class="grid md:grid-cols-2 gap-8">
              <!-- Left side: Partner -->
              <div>
                  <h4 class="font-medium mb-3">Có ai cùng thực hiện không?</h4>
                  <div class="flex gap-8">
                      <label class="flex items-center gap-2 text-sm cursor-pointer">
                          <input type="radio" name="partner" value="no" checked class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                          <span>Không</span>
                      </label>
                      <label class="flex items-center gap-2 text-sm cursor-pointer">
                          <input type="radio" name="partner" value="yes" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                          <span>Có</span>
                      </label>
                  </div>
                  <div id="partner-extra" class="mt-4 hidden">
                      <label class="block text-xs font-semibold tracking-wide text-slate-600 uppercase mb-1">% đóng góp của bạn</label>
                      <input id="partner-perc" type="number" min="0" max="100" class="w-32 px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
                  </div>
              </div>
              <!-- Right side: Time -->
              <div>
                  <h4 class="font-medium mb-3">Hoàn thành trong bao lâu (năm)</h4>
                  <input id="years-all" type="number" min="0" class="w-32 px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
                  <p class="text-sm text-slate-500 mt-2">Nhập 0 nếu chưa xác định.</p>
              </div>
          </div>
        </div>

        <!-- Quỹ -->
        <div class="sub-box space-y-8">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="ri-money-dollar-circle-line text-green-600"></i> Quỹ tương ứng
          </h3>

          <div id="fund-family" class="hidden space-y-4">
            <h4 class="font-semibold">Quỹ vận hành gia đình</h4>
            <div class="grid md:grid-cols-3 gap-5">
              <div>
                <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Chi phí/tháng</label>
                <input id="fam-monthly" data-money inputmode="numeric"
                  class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
              </div>
              <div>
                <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Số năm</label>
                <input id="fam-years" type="number" min="0"
                  class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
              </div>
              <div class="flex flex-col justify-end">
                <p class="text-xs text-slate-500">Tổng</p>
                <p class="font-semibold text-red-600" id="fam-total">0</p>
              </div>
            </div>
          </div>

          <div id="fund-edu" class="hidden space-y-4">
            <h4 class="font-semibold">Quỹ học vấn đại học cho con</h4>
            <div id="children" class="space-y-4"></div>
            <button id="add-child"
              class="text-sm font-medium px-4 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 transition">+ Thêm con</button>
            <div class="font-semibold mt-2 text-red-600">Tổng học vấn: <span id="edu-total">0</span></div>
          </div>

          <div id="fund-retire" class="hidden space-y-4">
            <h4 class="font-semibold">Quỹ hưu trí</h4>
            <div class="grid md:grid-cols-3 gap-5">
              <div>
                <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Số năm an nhàn</label>
                <input id="ret-years" type="number" min="0"
                  class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
              </div>
              <div>
                <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Chi tiêu/tháng</label>
                <input id="ret-month" data-money inputmode="numeric"
                  class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
              </div>
              <div class="flex flex-col justify-end">
                <p class="text-xs text-slate-500">Tổng</p>
                <p class="font-semibold text-red-600" id="ret-total">0</p>
              </div>
            </div>
          </div>

          <div id="fund-debt" class="hidden space-y-2">
            <h4 class="font-semibold">Thanh khoản nợ</h4>
            <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Số nợ hiện tại</label>
            <input id="debt" data-money inputmode="numeric"
              class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
          </div>

          <div id="fund-legacy" class="hidden space-y-2">
            <h4 class="font-semibold">Gia tăng tài sản / Di sản</h4>
            <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Giá trị kỳ vọng</label>
            <input id="legacy" data-money inputmode="numeric"
              class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
          </div>
          
          <div id="fund-custom" class="space-y-4"></div>
        </div>
      </div>

      <!-- Tổng hợp nhanh -->
      <div class="mt-10 bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-6">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
          <i class="ri-function-line text-blue-600"></i> Tổng hợp nhanh
        </h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold flex items-center gap-2">
              <i class="ri-shield-line text-green-600"></i> Số tiền trách nhiệm
            </h4>
            <ul id="resp-list" class="list-disc pl-5 space-y-1 text-sm mt-2"></ul>
            <p class="font-semibold mt-2">Tổng: <span id="resp-total">0</span></p>
          </div>
          <div>
            <h4 class="font-semibold flex items-center gap-2">
              <i class="ri-savings-line text-purple-600"></i> Số tiền phải tích luỹ
            </h4>
            <ul id="save-list" class="list-disc pl-5 space-y-1 text-sm mt-2"></ul>
            <p class="font-semibold mt-2">Tổng: <span id="save-total">0</span></p>
          </div>
        </div>
      </div>
    </section>

    <!-- FACTORS -->
    <section id="factors" class="section-card fade-in">
      <div class="flex items-center gap-3 mb-8">
        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-blue-500 rounded-xl flex items-center justify-center text-white">
          <i class="ri-lightbulb-line text-xl"></i>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold">Phần 2: Những yếu tố ảnh hưởng</h2>
      </div>

      <div class="space-y-8">
        <div class="p-6 rounded-xl border border-green-200 bg-green-50">
          <label class="block text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="ri-thumb-up-line text-green-600"></i> 1. Thuận lợi
          </label>
          <div class="flex flex-col sm:flex-row gap-3 mb-3">
            <input id="pos-input" placeholder="Nhập thuận lợi..."
              class="flex-1 px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-green-500 text-sm">
            <button id="add-pos" class="bg-green-600 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-green-700 transition">+ Thêm</button>
          </div>
          <div id="positives" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="p-6 rounded-xl border border-red-200 bg-red-50">
          <label class="block text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="ri-thumb-down-line text-red-600"></i> 2. Khó khăn
          </label>
          <div class="flex flex-col sm:flex-row gap-3 mb-3">
            <input id="neg-input" placeholder="Nhập khó khăn..."
              class="flex-1 px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-red-500 text-sm">
            <button id="add-neg" class="bg-red-600 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-red-700 transition">+ Thêm</button>
          </div>
          <p class="text-slate-600 text-sm mb-3">Chỉ khi bạn chọn ở mục 3 mới coi là "không thể khắc phục".</p>
          <div id="negatives" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="p-6 rounded-xl border border-yellow-200 bg-yellow-50">
          <label class="block text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="ri-alert-line text-yellow-600"></i> 3. Khó khăn không thể khắc phục
          </label>
          <div id="unmit" class="grid sm:grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>

        <div class="p-6 rounded-xl border border-purple-200 bg-purple-50">
          <label class="block text-lg font-semibold mb-4 flex items-center gap-2">
            <i class="ri-lightbulb-flash-line text-purple-600"></i> 4. Phương án thay thế
          </label>
          <div class="flex flex-col sm:flex-row gap-3 mb-3">
            <input id="alt-input" placeholder="Nhập phương án..."
              class="flex-1 px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-purple-500 text-sm">
            <button id="add-alt" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-medium text-sm hover:bg-purple-700 transition">+ Thêm</button>
          </div>
          <div id="alts" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="flex justify-center">
          <img src="images/anh-01.jpeg"
            alt="Minh họa tài chính" class="w-full max-w-2xl rounded-2xl shadow-lg object-cover">
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary" class="section-card fade-in">
      <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center text-white">
            <i class="ri-file-text-line text-xl"></i>
          </div>
          <h2 class="text-2xl md:text-3xl font-bold">Tóm tắt tổng quan</h2>
        </div>
      </div>

      <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10"></div>
      <div class="border-t border-slate-200 my-8"></div>
      <div class="grid md:grid-cols-2 gap-6 mb-10" id="mid-cards"></div>
      <div class="border-t border-slate-200 my-8"></div>
      <div id="details-section" class="space-y-10"></div>
      
      <div class="mt-10 flex justify-center gap-4 no-print">
        <button onclick="window.print()"
          class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition shadow-lg flex items-center gap-2">
          <i class="ri-download-line"></i> PDF
        </button>
        <button id="reset-btn"
          class="px-6 py-3 rounded-xl font-semibold border border-red-200 text-red-600 hover:bg-red-50 transition">
          Reset
        </button>
      </div>
    </section>
  </main>

  <footer class="bg-slate-900 text-slate-300 py-10 mt-10 no-print">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-sm flex flex-col md:flex-row justify-between gap-4">
      <p>© <span id="year"></span> Bản đồ tài chính cá nhân.</p>
      <p>Dữ liệu tạm thời (chưa bật lưu trình duyệt).</p>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    /* ====== CORE UTILS ====== */
    const fmt = new Intl.NumberFormat('vi-VN');
    const digits = s => (s||'').toString().replace(/\D/g,'');
    const money = v => fmt.format(+v||0);
    const val = id => {
      const el=document.getElementById(id);
      if(!el) return 0;
      return +digits(el.dataset.raw || el.value) || 0;
    };
    const PREDEFINED_GOALS = new Set([
      'Vận hành gia đình',
      'Quỹ học vấn cho con',
      'Quỹ hưu trí',
      'Trả nợ',
      'Gia tăng tài sản/ Để lại di sản',
      'Mở doanh nghiệp riêng'
    ]);

    /* ====== LIVE MONEY INPUT ======
       - Tự động format hàng nghìn khi gõ.
    */
    function bindMoneyLive(inp) {
        inp.addEventListener('input', () => {
            const { value, selectionStart } = inp;
            if (value === null || selectionStart === null) return;

            const digitsBeforeCursor = (value.substring(0, selectionStart).match(/\d/g) || []).length;
            const rawValue = value.replace(/\D/g, '');
            inp.dataset.raw = rawValue;

            if (rawValue === '') {
                calc();
                return;
            }

            const formattedValue = fmt.format(Number(rawValue));
            if (formattedValue === value) return;

            inp.value = formattedValue;

            let newCursorPosition = 0;
            if (digitsBeforeCursor === rawValue.length) {
                newCursorPosition = formattedValue.length;
            } else {
                let digitsCounted = 0;
                for (const char of formattedValue) {
                    newCursorPosition++;
                    if (/\d/.test(char)) {
                        digitsCounted++;
                    }
                    if (digitsCounted === digitsBeforeCursor) break;
                }
            }
            
            inp.setSelectionRange(newCursorPosition, newCursorPosition);
            calc();
        });
    }

    /* ====== STATE ====== */
    const state = {
      goals: [], must: [],
      reasons: [], pos: [], neg: [], unmit: [], alts: [],
      children: [],
      customFunds: {},
      lastTotals:{resp:0, save:0}
    };

    /* ====== RENDER FUNCTIONS ====== */
    function addGoal(goal){
      if(!goal) return;
      if(state.goals.includes(goal)){ alert('Mục tiêu đã tồn tại.'); return; }
      state.goals.push(goal);
      renderAll();
    }
    function addGeneric(arr,id){
      const el=document.getElementById(id);
      const v=el.value.trim();
      if(!v){ el.focus(); return; }
      if(arr.includes(v)){ alert('Đã tồn tại.'); el.focus(); return; }
      arr.push(v);
      el.value='';
      el.focus();
      renderAll();
    }

    function renderGoals(){
      const box=document.getElementById('priority-list');
      const mustBox=document.getElementById('must-list');
      box.innerHTML=''; mustBox.innerHTML='';
      state.goals.forEach(goal=>{
        const div=document.createElement('div');
        div.className='priority-item';
        if(state.must.includes(goal)) div.classList.add('selected');
        div.innerHTML='<span class="flex-1">'+goal+'</span><button type="button" class="remove-goal" aria-label="Xoá">×</button>';
        const btn=div.querySelector('.remove-goal');
        btn.onclick=e=>{
          e.stopPropagation();
          state.goals=state.goals.filter(g=>g!==goal);
          state.must=state.must.filter(g=>g!==goal);
          renderAll();
        };
        div.onclick=e=>{
          if(e.target===btn) return;
          if(state.must.includes(goal)) state.must=state.must.filter(x=>x!==goal);
          else state.must.push(goal);
          renderAll();
        };
        box.appendChild(div);

        if(state.must.includes(goal)){
          const chip=document.createElement('span');
          chip.className='chip';
          chip.style.background='linear-gradient(90deg,#2563eb,#7c3aed)';
          chip.style.color='#fff';
          chip.style.border='1px solid #2563eb';
          chip.innerHTML=goal+'<button aria-label="Bỏ chọn">×</button>';
          chip.querySelector('button').onclick=()=>{
            state.must=state.must.filter(g=>g!==goal);
            renderAll();
          };
          mustBox.appendChild(chip);
        }
      });
    }

    function renderChipArray(arr,containerId,extraClass=''){
      const box=document.getElementById(containerId);
      box.innerHTML='';
      arr.forEach((txt,i)=>{
        const span=document.createElement('span');
        span.className='chip '+extraClass;
        span.innerHTML='<span>'+txt+'</span><button aria-label="Xoá">×</button>';
        span.querySelector('button').onclick=()=>{
          arr.splice(i,1);
          if(containerId==='negatives'){
            const k=state.unmit.indexOf(txt);
            if(k!==-1) state.unmit.splice(k,1);
          }
          renderAll();
        };
        box.appendChild(span);
      });
    }

    function renderUnmit(){
      const box=document.getElementById('unmit');
      box.innerHTML='';
      state.neg.forEach(item=>{
        const div=document.createElement('div');
        div.className='priority-item text-xs py-2 px-3';
        if(state.unmit.includes(item)) div.classList.add('selected');
        div.textContent=item;
        div.onclick=()=>{
          if(state.unmit.includes(item)) state.unmit=state.unmit.filter(x=>x!==item);
          else state.unmit.push(item);
          renderUnmit(); updateSummary();
        };
        box.appendChild(div);
      });
    }

    function renderChildren(){
      const box=document.getElementById('children');
      box.innerHTML='';
      state.children.forEach((c,i)=>{
        const wrap=document.createElement('div');
        wrap.className='child-card';
        wrap.innerHTML=`
          <div class="grid md:grid-cols-4 gap-4 mb-3">
            <input placeholder="Tên con" value="${c.name||''}"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm child-name">
            <input placeholder="Trường" value="${c.school||''}"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm child-school">
            <input placeholder="Chi phí/năm" value="${c.cost?fmt.format(c.cost):''}" data-money inputmode="numeric"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm child-cost">
            <input type="number" min="0" placeholder="Số năm" value="${c.years||''}"
              class="px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm child-years">
          </div>
          <div class="flex items-center justify-between">
            <p class="text-sm">Tổng: <span class="font-semibold text-red-600 child-total">${money((c.cost||0)*(c.years||0))}</span></p>
            <button class="text-red-600 text-sm font-semibold hover:underline" type="button">Xoá</button>
          </div>
        `;
        const nameI=wrap.querySelector('.child-name'), schoolI=wrap.querySelector('.child-school');
        const costI=wrap.querySelector('.child-cost'), yearsI=wrap.querySelector('.child-years');
        const totalSpan=wrap.querySelector('.child-total'), delBtn=wrap.querySelector('button');

        if(c.cost){ costI.dataset.raw=c.cost.toString(); costI.value=fmt.format(c.cost); }
        bindMoneyLive(costI);

        costI.addEventListener('input', ()=>{
          c.cost = +digits(costI.dataset.raw||'')||0;
          totalSpan.textContent=money(c.cost*(c.years||0));
        });

        yearsI.oninput=e=>{ c.years=+e.target.value||0; totalSpan.textContent=money((c.cost||0)*c.years); calc(); };
        nameI.oninput=e=>{ c.name=e.target.value; updateSummary(); };
        schoolI.oninput=e=>{ c.school=e.target.value; };

        delBtn.onclick=()=>{ state.children.splice(i,1); renderChildren(); calc(); };
        box.appendChild(wrap);
      });
    }

    function updateFundsVisibility(){
      const show=(id,cond)=>document.getElementById(id).style.display = cond?'block':'none';
      show('fund-family', state.must.includes('Vận hành gia đình'));
      show('fund-edu', state.must.includes('Quỹ học vấn cho con'));
      show('fund-retire', state.must.includes('Quỹ hưu trí'));
      show('fund-debt', state.must.includes('Trả nợ'));
      show('fund-legacy', state.must.includes('Gia tăng tài sản/ Để lại di sản'));
    }
    
    function renderCustomFunds() {
        const box = document.getElementById('fund-custom');
        box.innerHTML = '';
        const newCustomFunds = {};

        state.must.forEach(goal => {
            if (PREDEFINED_GOALS.has(goal)) return;

            const currentVal = state.customFunds[goal] || 0;
            newCustomFunds[goal] = currentVal;

            const wrap = document.createElement('div');
            wrap.className = 'space-y-2';
            wrap.innerHTML = `
                <h4 class="font-semibold">${goal}</h4>
                <label class="block text-xs font-semibold tracking-wide text-slate-600 mb-1 uppercase">Số tiền</label>
                <input data-goal="${goal}" data-money inputmode="numeric"
                  class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm" />
            `;
            const input = wrap.querySelector('input');
            if (currentVal) {
                input.dataset.raw = currentVal.toString();
                input.value = fmt.format(currentVal);
            }
            bindMoneyLive(input);
            input.addEventListener('input', () => {
                newCustomFunds[goal] = +digits(input.dataset.raw || '') || 0;
                state.customFunds = newCustomFunds;
                calc();
            });
            box.appendChild(wrap);
        });
        state.customFunds = newCustomFunds;
    }

    /* ====== CALC & SUMMARY ====== */
    function calc(){
      let respSum=0, saveSum=0;
      const respList=document.getElementById('resp-list');
      const saveList=document.getElementById('save-list');
      respList.innerHTML=''; saveList.innerHTML='';

      if(state.must.includes('Vận hành gia đình')){
        const famMonthly=val('fam-monthly'), famYears=val('fam-years');
        const x=famMonthly*12*famYears;
        respSum += x;
        document.getElementById('fam-total').textContent=money(x);
        respList.innerHTML += `<li>Vận hành gia đình: ${money(x)}</li>`;
      } else document.getElementById('fam-total').textContent=money(0);

      if(state.must.includes('Quỹ học vấn cho con')){
        let totalEdu=0;
        state.children.forEach(c=> totalEdu += (c.cost||0)*(c.years||0));
        respSum += totalEdu;
        document.getElementById('edu-total').textContent=money(totalEdu);
        respList.innerHTML += `<li>Quỹ học vấn: ${money(totalEdu)}</li>`;
      } else document.getElementById('edu-total').textContent=money(0);

      if(state.must.includes('Quỹ hưu trí')){
        const x = val('ret-years') * val('ret-month') * 12;
        saveSum += x;
        document.getElementById('ret-total').textContent=money(x);
        saveList.innerHTML += `<li>Quỹ hưu trí: ${money(x)}</li>`;
      } else document.getElementById('ret-total').textContent=money(0);

      if(state.must.includes('Trả nợ')){
        const x=val('debt');
        respSum += x;
        respList.innerHTML += `<li>Trả nợ: ${money(x)}</li>`;
      }

      if(state.must.includes('Gia tăng tài sản/ Để lại di sản')){
        const x=val('legacy');
        respSum += x;
        respList.innerHTML += `<li>Di sản: ${money(x)}</li>`;
      }

      for (const goal in state.customFunds) {
          const amount = state.customFunds[goal];
          if (amount > 0) {
              respSum += amount;
              respList.innerHTML += `<li>${goal}: ${money(amount)}</li>`;
          }
      }

      document.getElementById('resp-total').textContent=money(respSum);
      document.getElementById('save-total').textContent=money(saveSum);
      state.lastTotals.resp=respSum;
      state.lastTotals.save=saveSum;
      updateSummary();
    }

    function buildDetailedFundsCard(){
        const respParts = [], saveParts = [];
        let respTotal = 0, saveTotal = 0;

        // Responsibility Funds
        if (state.must.includes('Vận hành gia đình')) {
            const m = val('fam-monthly'), y = val('fam-years'), total = m * 12 * y;
            respTotal += total;
            respParts.push(`<li><strong>Vận hành gia đình:</strong> <span class="formula">${money(m)}/tháng * 12 tháng * ${y} năm = ${money(total)}</span></li>`);
        }
        if (state.must.includes('Quỹ học vấn cho con')) {
            let eduLines = '', totalEdu = 0;
            state.children.forEach((c, i) => {
                const sub = (c.cost || 0) * (c.years || 0);
                totalEdu += sub;
                eduLines += `<li>${c.name || ('Con ' + (i + 1))}: <span class="formula">${money(c.cost || 0)}/năm * ${c.years || 0} năm = ${money(sub)}</span></li>`;
            });
            respTotal += totalEdu;
            respParts.push(`<li><strong>Quỹ học vấn:</strong> ${eduLines ? '<ul class="ml-5 list-disc space-y-1 mt-1">' + eduLines + '</ul>' : ''}</li>`);
        }
        if (state.must.includes('Trả nợ')) {
            const d = val('debt');
            respTotal += d;
            respParts.push(`<li><strong>Thanh khoản nợ:</strong> <span class="formula">${money(d)}</span></li>`);
        }
        if (state.must.includes('Gia tăng tài sản/ Để lại di sản')) {
            const l = val('legacy');
            respTotal += l;
            respParts.push(`<li><strong>Gia tăng tài sản/Di sản:</strong> <span class="formula">${money(l)}</span></li>`);
        }
        for (const goal in state.customFunds) {
            const amount = state.customFunds[goal];
            if (amount > 0) {
                respTotal += amount;
                respParts.push(`<li><strong>${goal}:</strong> <span class="formula">${money(amount)}</span></li>`);
            }
        }

        // Accumulation Funds
        if (state.must.includes('Quỹ hưu trí')) {
            const rm = val('ret-month'), ry = val('ret-years'), total = rm * 12 * ry;
            saveTotal += total;
            saveParts.push(`<li><strong>Quỹ hưu trí:</strong> <span class="formula">${money(rm)}/tháng * 12 tháng * ${ry} năm = ${money(total)}</span></li>`);
        }

        const respHtml = respParts.length ? `<ul class="list-disc ml-5 space-y-2">${respParts.join('')}</ul><div class="font-bold mt-3 border-t pt-2">Tổng: ${money(respTotal)}</div>` : '<p class="text-slate-500 italic text-sm">Chưa có.</p>';
        const saveHtml = saveParts.length ? `<ul class="list-disc ml-5 space-y-2">${saveParts.join('')}</ul><div class="font-bold mt-3 border-t pt-2">Tổng: ${money(saveTotal)}</div>` : '<p class="text-slate-500 italic text-sm">Chưa có.</p>';

        return `
            <div class="summary-card col-span-1 md:col-span-2">
                <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-folder-line text-blue-500"></i> Chi tiết các quỹ</h3>
                <div class="grid md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <h4 class="font-semibold text-green-700 mb-2">Quỹ trách nhiệm</h4>
                        ${respHtml}
                    </div>
                    <div>
                        <h4 class="font-semibold text-purple-700 mb-2">Quỹ tích lũy</h4>
                        ${saveHtml}
                    </div>
                </div>
            </div>
        `;
    }

    function updateSummary(){
      const cardsBox=document.getElementById('summary-cards');
      const mustGoals = state.must.length
        ? state.must.map(g=>`<li>${g}</li>`).join('')
        : '<span class="text-slate-500 italic text-sm">Chưa chọn</span>';
      const reasons = state.reasons.length
        ? state.reasons.map(r=>`<li>${r}</li>`).join('')
        : '<span class="text-slate-500 italic text-sm">Chưa nhập</span>';
      const partnerYes=document.querySelector('[name="partner"][value="yes"]').checked;
      const partnerPerc=document.getElementById('partner-perc').value;
      const yearsAll=document.getElementById('years-all').value;

      cardsBox.innerHTML=`
        <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-star-line text-yellow-500"></i> Mục tiêu quan trọng</h3>
          <ul class="list-disc ml-5 space-y-1 text-sm">${mustGoals}</ul>
        </div>
        <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-heart-line text-red-500"></i> Lý do</h3>
          <ul class="list-disc ml-5 space-y-1 text-sm">${reasons}</ul>
        </div>
        <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-team-line text-orange-500"></i> Người đồng hành và thời hạn hoàn thành</h3>
          <ul class="list-disc ml-5 space-y-1 text-sm">
            <li>Đồng hành: <strong>${partnerYes?'Có':'Không'}</strong> ${partnerYes&&partnerPerc?`(Đóng góp của bạn: ${partnerPerc}%)`:''}</li>
            <li>Thời gian hoàn thành: <strong>${yearsAll?yearsAll+' năm':'Chưa nhập'}</strong></li>
          </ul>
        </div>
        ${buildDetailedFundsCard()}
      `;

      const midBox=document.getElementById('mid-cards');
      const posList = state.pos.length ? '<ul class="list-disc ml-5 space-y-1">'+state.pos.map(x=>'<li>'+x+'</li>').join('')+'</ul>' : '<p class="text-slate-500 italic">Chưa có</p>';
      const unmit = state.unmit.length ? '<ul class="list-disc ml-5 space-y-1">'+state.unmit.map(x=>'<li>'+x+'</li>').join('')+'</ul>' : '<p class="text-slate-500 italic">Chưa chọn</p>';

      midBox.innerHTML=`
        <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-thumb-up-line text-green-500"></i> Thuận lợi</h3>
          ${posList}
        </div>
          <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-alert-line text-yellow-500"></i> Khó khăn không khắc phục</h3>
          ${unmit}
        </div>
      `;
      
      const alts = state.alts.length ? '<ul class="list-disc ml-5 space-y-1">'+state.alts.map(a=>'<li>'+a+'</li>').join('')+'</ul>' : '<p class="text-slate-500 italic">Chưa có</p>';
      const details=document.getElementById('details-section');
      details.innerHTML=`
        <div class="summary-card">
          <h3 class="text-lg font-bold flex items-center gap-2"><i class="ri-lightbulb-flash-line text-purple-500"></i> Phương án thay thế</h3>
          ${alts}
        </div>
      `;
    }

    function renderAll(){
      renderGoals();
      renderChipArray(state.reasons,'reasons');
      renderChipArray(state.pos,'positives','chip-positive');
      renderChipArray(state.neg,'negatives','chip-negative');
      renderUnmit();
      renderChipArray(state.alts,'alts','chip-alt');
      renderChildren();
      updateFundsVisibility();
      renderCustomFunds();
      calc();
    }

    /* ====== EVENTS ====== */
    document.getElementById('add-goal').onclick=()=>{
      const inp=document.getElementById('goal-input'); const v=inp.value.trim();
      if(!v) { inp.focus(); return; }
      addGoal(v); inp.value=''; inp.focus();
    };
    document.getElementById('add-reason').onclick=()=>addGeneric(state.reasons,'reason-input');
    document.getElementById('add-pos').onclick=()=>addGeneric(state.pos,'pos-input');
    document.getElementById('add-neg').onclick=()=>addGeneric(state.neg,'neg-input');
    document.getElementById('add-alt').onclick=()=>addGeneric(state.alts,'alt-input');

    document.getElementById('add-child').onclick=()=>{
      if(state.children.length<6){
        state.children.push({name:'',school:'',cost:0,years:0});
        renderChildren(); calc();
      } else alert('Tối đa 6 con.');
    };

    document.querySelectorAll('[name="partner"]').forEach(r=>{
      r.onchange=()=>{
        document.getElementById('partner-extra').classList.toggle('hidden', r.value!=='yes');
        updateSummary();
      };
    });

    ['fam-years','ret-years','partner-perc','years-all'].forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', calc);
    });

    ['fam-monthly','ret-month','debt','legacy'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) bindMoneyLive(el);
    });

    document.getElementById('reset-btn').onclick=()=>{
      if(confirm('Xoá toàn bộ dữ liệu hiện tại?')){
        Object.assign(state,{goals:[],must:[],reasons:[],pos:[],neg:[],unmit:[],alts:[],children:[],customFunds:{},lastTotals:{resp:0,save:0}});
        document.querySelectorAll('input').forEach(i=>{
          if(i.type!=='radio'){ i.value=''; i.dataset.raw=''; }
          if(i.type==='radio' && i.value==='no') i.checked=true;
        });
        document.getElementById('partner-extra').classList.add('hidden');
        renderAll();
        document.getElementById('goal-input').focus();
      }
    };

    document.getElementById('year').textContent=new Date().getFullYear();

    // Init
    renderAll();
  </script>
</body>
</html>
