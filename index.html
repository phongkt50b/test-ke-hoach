<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n ‚Äî Thi·∫øt k·∫ø + Quy t·∫Øc g·ªëc</title>
  <!-- Tailwind d√πng cho layout nh·∫•t qu√°n (n·∫øu m√¥i tr∆∞·ªùng b·∫°n ch·∫∑n CDN th√¨ v·∫´n ch·∫°y logic b√¨nh th∆∞·ªùng;
       ch·ªâ kh√°c nh·∫π ph·∫ßn th·∫©m m·ªπ). C√≥ th·ªÉ b·ªè d√≤ng n√†y n·∫øu kh√¥ng c·∫ßn. -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <!-- Gi·ªØ nguy√™n style.css c·ªßa b·∫°n c·∫°nh file HTML -->
  <link href="style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{ --ink:#1f2937; --muted:#6b7280; --aia:#C81E26; }
    body{ font-family:"Be Vietnam Pro", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card{ background:#fff; border:1px solid #E5E7EB; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .section-title{ font-size:1.25rem; font-weight:700; color:var(--aia); }
    .form-input, .form-select{ width:100%; background:#fff; border:1px solid #D1D5DB; border-radius:.5rem; padding:.6rem .75rem; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.6rem .9rem; border-radius:.6rem; font-weight:600; }
    .btn-primary{ background:var(--aia); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; background:#F3F4F6; border:1px solid #E5E7EB; padding:.25rem .6rem; font-size:.9rem; margin-right:.5rem; margin-bottom:.5rem; }
    .chip button{ margin-left:.5rem; color:#6B7280; }
    .dnd .item{ padding:10px 12px; border:1px dashed #cbd5e1; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:space-between; cursor:grab; }
    .dnd .item.dragging{ opacity:.6 }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    @media print{
      .no-print{ display:none !important; }
      .page-break{ page-break-after:always; }
      body{ background:#fff; }
      .card{ box-shadow:none; border:0 }
      #unmit-select option.selected-option {
  background-color: var(--aia);
  color: white;
  font-weight: 600;
}

    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Header -->
    <header class="flex items-center justify-between pb-6 border-b-2" style="border-color:var(--aia)">
      <div class="flex items-center gap-3">
        <img src="https://www.aia.com.vn/content/dam/group-wise/images/system/icons/aia-logo-red.svg" alt="AIA Logo" class="h-8"/>
        <h1 class="text-2xl sm:text-3xl font-bold">B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n</h1>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-preview" class="btn btn-ghost">Xem b·∫£n in</button>
        <button id="btn-print" class="btn btn-primary">Xu·∫•t PDF</button>
      </div>
    </header>

    <!-- Main grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6" id="app">
      <!-- LEFT 2/3: Forms -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Th√¥ng tin chung -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Th√¥ng tin chung</h2><span class="text-xs text-gray-600">Ph·∫ßn ƒë·∫ßu</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm text-gray-600 mb-1">H·ªç v√† t√™n</label><input id="fullname" class="form-input" placeholder="Nguy·ªÖn VƒÉn A"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng√†y sinh</label><input id="dob" type="date" class="form-input"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ngh·ªÅ nghi·ªáp</label><input id="job" class="form-input" placeholder="Chuy√™n vi√™n t√†i ch√≠nh..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng∆∞·ªùi ph·ª• thu·ªôc tr·ª±c ti·∫øp</label><input id="dep-direct" class="form-input" placeholder="V·ª£/ch·ªìng, con nh·ªè..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng∆∞·ªùi ph·ª• thu·ªôc gi√°n ti·∫øp</label><input id="dep-indirect" class="form-input" placeholder="B·ªë m·∫π, th√¢n nh√¢n..."/></div>
          </div>
        </section>
        <!-- M·ª•c ti√™u & b·∫Øt bu·ªôc -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">M·ª•c ti√™u/ K·∫ø ho·∫°ch t√†i ch√≠nh </h2><span class="text-xs text-gray-600">Ph·∫ßn 2 &amp; 3</span>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Th√™m m·ª•c ti√™u (g·ª£i √Ω)</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <input id="goal-input" list="goal-suggest" class="form-input" placeholder="V√≠ d·ª•: V·∫≠n h√†nh gia ƒë√¨nh"/>
                <datalist id="goal-suggest">
                  <option value="V·∫≠n h√†nh gia ƒë√¨nh"></option>
                  <option value="Qu·ªπ h·ªçc v·∫•n cho con"></option>
                  <option value="Qu·ªπ h∆∞u tr√≠"></option>
                  <option value="Tr·∫£ n·ª£"></option>
                  <option value="Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n"></option>
                  <option value="M·ªü doanh nghi·ªáp ri√™ng"></option>
                </datalist>
              </div>
              <div class="flex items-end"><button class="btn btn-primary w-full" id="add-goal">Th√™m m·ª•c ti√™u</button></div>
            </div>
            <div class="mt-3" id="goals"></div>
            <div class="my-4 border-t"></div>
          </div>
        </section>
        
        <!-- ∆Øu ti√™n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">M·ª•c ti√™u n√†o l√† quan tr·ªçng nh·∫•t, ph·∫£i l√†m b·∫±ng m·ªçi gi√° </h2><span class="text-xs text-gray-600">Ph·∫ßn 5</span>
          </div>
          <p class="text-gray-600 text-sm mb-2">K√©o th·∫£ t·ª´ <b>quan tr·ªçng nh·∫•t</b> xu·ªëng <b>√≠t quan tr·ªçng nh·∫•t</b>. Danh s√°ch l·∫•y t·ª´ m·ª•c 3.</p>
          <div class="dnd space-y-2" id="priority-list"></div>
        </section>

        <!-- L√Ω do -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">L√Ω do b·∫Øt bu·ªôc</h2><span class="text-xs text-gray-600">Ph·∫ßn 4</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-600 mb-1">Th√™m l√Ω do</label>
              <input id="reason-input" class="form-input" placeholder="V√≠ d·ª•: B·∫£o v·ªá con c√°i tr∆∞·ªõc r·ªßi ro"/>
            </div>
            <div class="flex items-end"><button class="btn btn-primary w-full" id="add-reason">Th√™m l√Ω do</button></div>
          </div>
          <div class="mt-3" id="reasons"></div>
        </section>

        <!-- C√°c qu·ªπ c·∫ßn thi·∫øt -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">ƒêo l∆∞·ªùng k·∫ø ho·∫°ch t√†i ch√≠nh </h2><span class="text-xs text-gray-600">T·ª± ƒë·ªông hi·ªÉn th·ªã theo ∆∞u ti√™n</span>
          </div>
          <div id="funds">
            <details id="fund-family" open data-match="V·∫≠n h√†nh gia ƒë√¨nh" class="mb-4">
              <summary class="cursor-pointer font-semibold">V·∫≠n h√†nh gia ƒë√¨nh</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Chi ph√≠ thi·∫øt y·∫øu / th√°ng (‚Ç´)</label><input id="fam-monthly" type="number" min="0" step="1000" class="form-input" placeholder="XX"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Trang tr·∫£i t·ªëi thi·ªÉu trong (nƒÉm)</label><input id="fam-years" type="number" min="0" step="1" class="form-input" placeholder="YY"/></div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1">Qu·ªπ v·∫≠n h√†nh gia ƒë√¨nh c·∫ßn c√≥</label>
                  <div id="fam-total" class="font-bold text-[var(--aia)] mono mt-2">‚Ç´0</div>
                </div>
              </div>
            </details>

            <details id="fund-edu" data-match="Qu·ªπ h·ªçc v·∫•n cho con" class="mb-4">
              <summary class="cursor-pointer font-semibold">Qu·ªπ h·ªçc v·∫•n ƒë·∫°i h·ªçc cho con</summary>
              <div id="children" class="mt-3"></div>
              <div class="flex items-center gap-3 mt-3">
                <button class="btn btn-ghost border w-fit" id="add-child">+ Th√™m con</button>
                <span class="text-sm text-gray-600">T·ªëi ƒëa 6 con.</span>
              </div>
              <div class="mt-3">
                <label class="block text-sm text-gray-600 mb-1">T·ªïng qu·ªπ h·ªçc v·∫•n</label>
                <div id="edu-total" class="font-bold text-[var(--aia)] mono">‚Ç´0</div>
              </div>
            </details>

            <details id="fund-retire" data-match="Qu·ªπ h∆∞u tr√≠" class="mb-4">
              <summary class="cursor-pointer font-semibold">Qu·ªπ h∆∞u tr√≠</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Tu·ªïi ngh·ªâ h∆∞u</label><input id="ret-age" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">S·ªëng an nh√†n trong (nƒÉm) ‚Äì xx</label><input id="ret-years" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Chi ti√™u c√° nh√¢n / th√°ng ‚Äì yy (‚Ç´)</label><input id="ret-month" type="number" min="0" step="1000" class="form-input"/></div>
              </div>
              <div class="mt-3">
                <label class="block text-sm text-gray-600 mb-1">T·ªïng qu·ªπ h∆∞u tr√≠ = xx √ó yy √ó 12</label>
                <div id="ret-total" class="font-bold text-[var(--aia)] mono">‚Ç´0</div>
              </div>
            </details>

            <details id="fund-debt" data-match="Tr·∫£ n·ª£" class="mb-4">
              <summary class="cursor-pointer font-semibold">Thanh kho·∫£n c√°c kho·∫£n n·ª£</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Kho·∫£n n·ª£ hi·ªán t·∫°i (‚Ç´)</label><input id="debt-amt" type="number" min="0" step="1000" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Th·ªùi h·∫°n c·∫ßn tr·∫£ (nƒÉm)</label><input id="debt-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>

            <details id="fund-legacy" data-match="Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n">
              <summary class="cursor-pointer font-semibold">Gia tƒÉng t√†i s·∫£n / ƒê·ªÉ l·∫°i di s·∫£n</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Gi√° tr·ªã t√†i s·∫£n k·ª≥ v·ªçng (‚Ç´)</label><input id="legacy-amt" type="number" min="0" step="1000" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Th·ªùi gian d·ª± ki·∫øn (nƒÉm)</label><input id="legacy-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>
          </div>
        </section>
        
        <!-- ƒê·ªìng h√†nh & th·ªùi h·∫°n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Th√†nh vi√™n c√πng th·ª±c hi·ªán &amp; Th·ªùi h·∫°n</h2><span class="text-xs text-gray-600">Ph·∫ßn 6 &amp; 7</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">C√≥ ai c√πng th·ª±c hi·ªán m·ª•c ti√™u kh√¥ng?</label>
              <div class="flex items-center gap-6">
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="no" checked/> Kh√¥ng</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="yes"/> C√≥</label>
              </div>
            </div>
            <div id="partner-perc-wrap" style="display:none">
              <label class="block text-sm text-gray-600 mb-1">% c√¥ng s·ª©c c·ªßa anh/ch·ªã</label>
              <input id="partner-perc" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
            <div><label class="block text-sm text-gray-600 mb-1">D·ª± ƒë·ªãnh ho√†n th√†nh t·∫•t c·∫£ trong (nƒÉm)</label><input id="years-all" type="number" min="0" step="1" class="form-input" placeholder="S·ªë nƒÉm"/></div>
          </div>
        </section>

        <!-- R√†o c·∫£n & ph∆∞∆°ng √°n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">R√†o c·∫£n &amp; Ph∆∞∆°ng √°n</h2><span class="text-xs text-gray-600">Ph·∫ßn 9‚Äì11</span>
          </div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">9) Y·∫øu t·ªë khi·∫øn kh√¥ng ƒë·∫°t m·ª•c ti√™u</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Th√™m y·∫øu t·ªë</label><input id="risk-input" class="form-input" placeholder="V√≠ d·ª•: ·ªêm ƒëau, th·∫•t nghi·ªáp..."/></div>
              <div class="flex items-end"><button class="btn btn-primary w-full" id="add-risk">Th√™m y·∫øu t·ªë</button></div>
            </div>
            <div id="risks" class="mt-3"></div>
          </details>
          <div class="border-t my-3"></div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">10) Y·∫øu t·ªë kh√¥ng th·ªÉ l∆∞·ªùng tr∆∞·ªõc &amp; kh√¥ng th·ªÉ kh·∫Øc ph·ª•c (ch·ªçn nhi·ªÅu)</summary>
            <select id="unmit-select" multiple size="6" class="form-select w-full mt-2"></select>
            <p class="text-xs text-gray-500">Ch·ªçn t·ª´ danh s√°ch ƒë√£ nh·∫≠p ·ªü c√¢u 9.</p>
          </details>
          <div class="border-t my-3"></div>
          <details open>
            <summary class="cursor-pointer font-semibold">11) Ph∆∞∆°ng √°n thay th·∫ø</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Th√™m ph∆∞∆°ng √°n</label><input id="alt-input" class="form-input" placeholder="V√≠ d·ª•: D·ª± ph√≤ng 12 th√°ng chi ti√™u..."/></div>
              <div class="flex items-end"><button class="btn btn-primary w-full" id="add-alt">Th√™m ph∆∞∆°ng √°n</button></div>
            </div>
            <div id="alts" class="mt-3"></div>
          </details>
        </section>
      </div>

      <!-- RIGHT 1/3: Totals -->
      <aside class="lg:col-span-1">
        <section class="card p-5 sticky top-8">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">T·ªïng h·ª£p qu·ªπ tr√°ch nhi·ªám</h2>
            <button class="btn btn-ghost no-print" id="btn-calc">C·∫≠p nh·∫≠t t·ªïng h·ª£p</button>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <h3 class="font-semibold">S·ªë ti·ªÅn tr√°ch nhi·ªám ‚Äì <span class="text-gray-500">c·∫ßn lu√¥n s·∫µn s√†ng</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="resp-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td id="resp-total" class="py-2 text-right font-semibold mono">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">S·ªë ti·ªÅn tr√°ch nhi·ªám ƒë√£ chu·∫©n b·ªã (‚Ç´)</label><input id="resp-prepared" type="number" min="0" step="1000" class="form-input"/></div>
                <div class="flex flex-col"><span class="text-gray-700">Kho·∫£ng thi·∫øu (∆∞·ªõc t√≠nh)</span><span id="resp-gap" class="font-bold text-red-600 mono text-lg mt-1">‚Ç´0</span></div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold">S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ ‚Äì <span class="text-gray-500">d√πng trong t∆∞∆°ng lai</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="save-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td id="save-total" class="py-2 text-right font-semibold mono">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">Mong mu·ªën ho√†n th√†nh (%)</label><input id="goal-percent" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/></div>
            </div>
          </div>
        </section>
      </aside>
    </main>

    <!-- bottom toolbar -->
    <div class="no-print fixed bottom-0 inset-x-0 bg-white/85 backdrop-blur border-t">
      <div class="container mx-auto p-3 flex items-center gap-3">
        <p class="text-sm text-gray-600">üí° Nh·∫•n <b>Xem b·∫£n in</b> ƒë·ªÉ xem PDF tr∆∞·ªõc khi xu·∫•t.</p>
        <span class="flex-1"></span>
        <button class="btn btn-ghost" id="btn-reset">Xo√° d·ªØ li·ªáu</button>
        <button class="btn btn-primary" id="btn-print-2">Xu·∫•t PDF</button>
      </div>
    </div>

    <!-- Print preview -->
    <section id="print-view" class="mt-10 hidden">
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">T√≥m t·∫Øt kh√°ch h√†ng</h2>
        <div id="print-client" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">M·ª•c ti√™u & ∆Øu ti√™n</h2>
        <div id="print-goals" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">C√°c qu·ªπ & T·ªïng h·ª£p</h2>
        <div id="print-funds" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <script>
  // ===== Utilities & shared state (kh·ªõp v·ªõi b·∫£n quy t·∫Øc) =====
  const fmt = new Intl.NumberFormat('vi-VN');
  const el = id => document.getElementById(id);
  const money = v => '‚Ç´' + fmt.format(Number(v||0));

  const state = {
    goals: [], mustGoals: [], reasons: [], risks: [], unmitigable: [], alts: [],
    children: [],  // {name, school, cost, years}
    _priority: []  // m·ª•c ti√™u quan tr·ªçng nh·∫•t
  };

  // ===== Render chips =====
  function renderChips(arr, mountId){
    const mount = el(mountId);
    mount.innerHTML = '';
    arr.forEach((txt, i)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = '<span>'+txt+'</span><button title="X√≥a" data-i="'+i+'">√ó</button>';
      chip.querySelector('button').onclick = ()=>{ arr.splice(i,1); render(); };
      mount.appendChild(chip);
    });
  }
  function uniquePush(arr, item){
    const s = (item||'').trim();
    if(!s) return;
    if(!arr.includes(s)) arr.push(s);
  }
  function syncMustGoals(){
    const sel = el('must-goals');
    sel.innerHTML = '';
    state.goals.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g; opt.textContent = g;
      sel.appendChild(opt);
    });
    Array.from(sel.options).forEach(op=> op.selected = state.mustGoals.includes(op.value));
  }
  function syncUnmitigable(){
    const sel = el('unmit-select');
    sel.innerHTML = '';
    state.risks.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r; opt.textContent = r;
      sel.appendChild(opt);
    });
    Array.from(sel.options).forEach(op=> op.selected = state.unmitigable.includes(op.value));
    updateUnmitSelectStyles();
  }

  // ===== Priority (m·ª•c ti√™u quan tr·ªçng nh·∫•t) =====
  function buildPriorityList(){
    const mount = el('priority-list');
    mount.innerHTML = '';

    if (!Array.isArray(state._priority)) state._priority = [];

    state.goals.forEach((goal) => {
      const item = document.createElement('div');
      item.className = 'item';
      item.textContent = goal;
      item.style.cursor = 'pointer';

      if (state._priority.includes(goal)) {
        item.style.backgroundColor = 'var(--aia)';
        item.style.color = '#fff';
        item.style.fontWeight = '600';
      } else {
        item.style.backgroundColor = '';
        item.style.color = '';
        item.style.fontWeight = '';
      }

      item.addEventListener('click', () => {
        const index = state._priority.indexOf(goal);
        if (index === -1) {
          state._priority.push(goal);
        } else {
          state._priority.splice(index, 1);
        }
        buildPriorityList();
        updateFundsVisibility();
      });

      mount.appendChild(item);
    });
  }

  // ===== Events =====
  el('add-goal').onclick = ()=>{ uniquePush(state.goals, el('goal-input').value); el('goal-input').value=''; render(); };
  el('add-reason').onclick = ()=>{ uniquePush(state.reasons, el('reason-input').value); el('reason-input').value=''; render(); };
  el('add-risk').onclick = ()=>{ uniquePush(state.risks, el('risk-input').value); el('risk-input').value=''; render(); };
  el('add-alt').onclick = ()=>{ uniquePush(state.alts, el('alt-input').value); el('alt-input').value=''; render(); };

  el('must-goals').addEventListener('change', ()=>{
    const sel = el('must-goals');
    state.mustGoals = Array.from(sel.selectedOptions).map(o=>o.value);
    render();
  });

  el('unmit-select').addEventListener('change', () => {
    const sel = el('unmit-select');
    state.unmitigable = Array.from(sel.selectedOptions).map(o => o.value);
    updateUnmitSelectStyles();
  });

  // ===== Style cho c√°c option ƒë∆∞·ª£c ch·ªçn trong unmit-select =====
  function updateUnmitSelectStyles() {
    const unmitSelect = el('unmit-select');
    Array.from(unmitSelect.options).forEach(opt => {
      if (state.unmitigable.includes(opt.value)) {
        opt.classList.add('selected-option');
      } else {
        opt.classList.remove('selected-option');
      }
    });
  }

  // ===== Visibility rules =====
  function goalMatchName(txt){ return (txt||'').trim().toLowerCase(); }
  const NAME_FAMILY = goalMatchName('V·∫≠n h√†nh gia ƒë√¨nh');
  const NAME_EDU = goalMatchName('Qu·ªπ h·ªçc v·∫•n cho con');
  const NAME_RET = goalMatchName('Qu·ªπ h∆∞u tr√≠');
  const NAME_DEBT = goalMatchName('Tr·∫£ n·ª£');
  const NAME_LEG = goalMatchName('Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n');

  function updateFundsVisibility(){
    const pr = (state._priority||[]).map(goalMatchName);
    const map = {
      'fund-family': pr.includes(NAME_FAMILY),
      'fund-edu': pr.includes(NAME_EDU),
      'fund-retire': pr.includes(NAME_RET),
      'fund-debt': pr.includes(NAME_DEBT),
      'fund-legacy': pr.includes(NAME_LEG),
    };
    Object.entries(map).forEach(([id, show])=>{
      const d = el(id);
      if(!d) return;
      d.style.display = show ? 'block' : 'none';
    });
  }

  // ===== Children (6 t·ªëi ƒëa) =====
  const childMax = 6;
  function childRow(idx, data){
    const wrap = document.createElement('div');
    wrap.className='card p-4 mt-3 border border-gray-200';
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label class="block text-sm text-gray-600 mb-1">Con th·ª© #${idx+1} - H·ªç t√™n</label><input data-k="name" class="form-input" value="${data?.name||''}" placeholder="T√™n con"/></div>
        <div><label class="block text-sm text-gray-600 mb-1">Tr∆∞·ªùng d·ª± ƒë·ªãnh</label><input data-k="school" class="form-input" value="${data?.school||''}" placeholder="T√™n tr∆∞·ªùng"/></div>
        <div><label class="block text-sm text-gray-600 mb-1">Chi ph√≠ 1 nƒÉm (‚Ç´)</label><input data-k="cost" type="number" min="0" step="1000" class="form-input" value="${data?.cost||''}"/></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
        <div><label class="block text-sm text-gray-600 mb-1">S·ªë nƒÉm h·ªçc ƒë·∫°i h·ªçc</label><input data-k="years" type="number" min="0" step="1" class="form-input" value="${data?.years||''}"/></div>
        <div class="flex flex-col justify-center"><div class="text-sm text-gray-600">T·ªïng h·ªçc ph√≠ (#${idx+1})</div><div class="font-bold text-[var(--aia)] mono child-total">‚Ç´0</div></div>
        <div class="flex items-center justify-end"><button class="btn btn-ghost border text-red-600">Xo√°</button></div>
      </div>`;
    wrap.querySelectorAll('input[data-k]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const k = inp.getAttribute('data-k');
        state.children[idx][k] = inp.type==='number' ? Number(inp.value||0) : inp.value;
        calcEdu();
      });
    });
    wrap.querySelector('button').onclick = ()=>{
      state.children.splice(idx,1);
      renderChildren();
    };
    return wrap;
  }
  function renderChildren(){
    const mount = el('children');
    mount.innerHTML='';
    state.children.forEach((c,i)=> mount.appendChild(childRow(i,c)));
    calcEdu();
  }
  el('add-child').onclick = ()=>{
    if(state.children.length >= childMax){ alert('T·ªëi ƒëa 6 con.'); return; }
    state.children.push({name:'', school:'', cost:0, years:0});
    renderChildren();
  };

  // ===== T√≠nh to√°n =====
  function calcFamily(){
    const monthly = parseNumber(el('fam-monthly').value);
    const years = parseNumber(el('fam-years').value);
    const total = monthly * 12 * years;
    el('fam-total').textContent = money(total);
    return total;
  }
  function calcEdu(){
    let sum = 0;
    state.children.forEach((c, i)=>{
      const t = Number(c.cost||0) * Number(c.years||0);
      sum += t;
      const mount = el('children').children[i];
      if(mount){
        const tv = mount.querySelector('.child-total');
        if(tv) tv.textContent = money(t);
      }
    });
    el('edu-total').textContent = money(sum);
    return sum;
  }
  function calcRetire(){
    const xx = parseNumber(el('ret-years').value);
    const yy = parseNumber(el('ret-month').value);
    const total = xx * yy * 12;
    el('ret-total').textContent = money(total);
    return total;
  }
  function calcDebt(){ return parseNumber(el('debt-amt').value); }
  function calcLegacy(){ return parseNumber(el('legacy-amt').value); }

  function calcAll(){
    const fam = calcFamily();
    const edu = calcEdu();
    const ret = calcRetire();
    const debt = calcDebt();
    const leg = calcLegacy();

    const respItems = [];
    if(el('fund-family').style.display!=='none') respItems.push(['V·∫≠n h√†nh gia ƒë√¨nh', fam]);
    if(el('fund-edu').style.display!=='none') respItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
    if(el('fund-debt').style.display!=='none') respItems.push(['Thanh kho·∫£n c√°c kho·∫£n n·ª£', debt]);
    if(el('fund-legacy').style.display!=='none') respItems.push(['ƒê·ªÉ l·∫°i di s·∫£n', leg]);
    const respBody = el('resp-body');
    respBody.innerHTML = respItems.map(([k,v])=> `<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
    const respSum = respItems.reduce((a, [,v])=>a+Number(v||0), 0);
    el('resp-total').textContent = money(respSum);

    const prepared = parseNumber(el('resp-prepared').value);
    el('resp-gap').textContent = money(Math.max(respSum - prepared, 0));

    const saveItems = [];
    if(el('fund-retire').style.display!=='none') saveItems.push(['Qu·ªπ h∆∞u tr√≠', ret]);
    if(el('fund-edu').style.display!=='none') saveItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
    const saveBody = el('save-body');
    saveBody.innerHTML = saveItems.map(([k,v])=> `<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
    const saveSum = saveItems.reduce((a, [,v])=>a+Number(v||0), 0);
    el('save-total').textContent = money(saveSum);
  }

  // H√†m parse s·ªë t·ª´ chu·ªói c√≥ d·∫•u ch·∫•m ngƒÉn c√°ch
  function parseNumber(str){
    if(!str) return 0;
    return Number(str.toString().replace(/\./g, '').replace(/[^0-9]/g, '')) || 0;
  }

  // ===== Format input s·ªë c√≥ d·∫•u ch·∫•m ngƒÉn c√°ch ph·∫ßn ngh√¨n =====
  function formatNumberInput(input) {
    let value = input.value.replace(/\./g, '').replace(/[^0-9]/g, '');
    if (value === '') {
      input.value = '';
      return;
    }
    let num = parseInt(value, 10);
    if (isNaN(num)) {
      input.value = '';
      return;
    }
    input.value = num.toLocaleString('vi-VN');
  }

  // √Åp d·ª•ng format cho t·∫•t c·∫£ input ti·ªÅn, b·ªè t·ª± ƒë·ªông t√≠nh khi nh·∫≠p
  ['fam-monthly','fam-years','ret-years','ret-month','debt-amt','legacy-amt','resp-prepared'].forEach(id => {
    const input = el(id);
    input.removeEventListener('input', calcAll); // B·ªè t·ª± ƒë·ªông t√≠nh
    input.addEventListener('input', () => {
      formatNumberInput(input);
    });
  });

  // N√∫t c·∫≠p nh·∫≠t t·ªïng h·ª£p v·∫´n gi·ªØ t√≠nh nƒÉng
  el('btn-calc').onclick = calcAll;

  // ===== Print =====
  function buildPrint(){
    const client = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><div class="text-sm text-gray-500">H·ªç v√† t√™n</div><div class="mono">${el('fullname').value||''}</div></div>
        <div><div class="text-sm text-gray-500">Ng√†y sinh</div><div class="mono">${el('dob').value||''}</div></div>
        <div><div class="text-sm text-gray-500">Ngh·ªÅ nghi·ªáp</div><div class="mono">${el('job').value||''}</div></div>
        <div><div class="text-sm text-gray-500">Ph·ª• thu·ªôc tr·ª±c ti·∫øp</div><div class="mono">${el('dep-direct').value||''}</div></div>
        <div><div class="text-sm text-gray-500">Ph·ª• thu·ªôc gi√°n ti·∫øp</div><div class="mono">${el('dep-indirect').value||''}</div></div>
        <div><div class="text-sm text-gray-500">Video: Chi·∫øc thuy·ªÅn (URL)</div><div class="mono">${el('vid-boat')?.value||''}</div></div>
        <div class="md:col-span-2"><div class="text-sm text-gray-500">Video: G·∫∑p b√£o (URL)</div><div class="mono">${el('vid-storm')?.value||''}</div></div>
      </div>`;
    el('print-client').innerHTML = client;

    const goalsHtml = `
      <div><span class="text-gray-600">T·∫•t c·∫£ m·ª•c ti√™u:</span> <span class="font-medium">${state.goals.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div><span class="text-gray-600">M·ª•c ti√™u b·∫Øt bu·ªôc:</span> <span class="font-medium">${state.mustGoals.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div><span class="text-gray-600">∆Øu ti√™n:</span><div class="mt-1">${(state._priority||[]).map((g,i)=> (i+1)+'. '+g).join('<br/>') || '‚Äî'}</div></div>
      <hr class="my-2"/>
      <div><span class="text-gray-600">L√Ω do:</span> <span class="font-medium">${state.reasons.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div><span class="text-gray-600">Y·∫øu t·ªë c·∫£n tr·ªü:</span> <span class="font-medium">${state.risks.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div><span class="text-gray-600">Kh√¥ng l∆∞·ªùng tr∆∞·ªõc/kh√≥ kh·∫Øc ph·ª•c:</span> <span class="font-medium">${state.unmitigable.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div><span class="text-gray-600">Ph∆∞∆°ng √°n thay th·∫ø:</span> <span class="font-medium">${state.alts.join(' ¬∑ ')||'‚Äî'}</span></div>
      <div class="mt-2"><span class="text-gray-600">C√≥ ƒë·ªìng h√†nh:</span> <span class="font-medium">${document.querySelector('input[name="partner"]:checked')?.value==='yes'?'C√≥':'Kh√¥ng'}</span></div>
      <div><span class="text-gray-600">% ƒë√≥ng g√≥p:</span> <span class="font-medium">${el('partner-perc').value||'‚Äî'}</span></div>
      <div><span class="text-gray-600">Th·ªùi gian ho√†n th√†nh (nƒÉm):</span> <span class="font-medium">${el('years-all').value||'‚Äî'}</span></div>`;
    el('print-goals').innerHTML = goalsHtml;

    calcAll();
    const fundsHtml = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold mb-2">S·ªë ti·ªÅn tr√°ch nhi·ªám</h3>
          <table class="w-full text-sm">
            <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
            <tbody>${el('resp-body').innerHTML}</tbody>
            <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td class="py-2 text-right font-semibold mono">${el('resp-total').textContent}</td></tr></tfoot>
          </table>
        </div>
        <div>
          <h3 class="font-semibold mb-2">S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ</h3>
          <table class="w-full text-sm">
            <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
            <tbody>${el('save-body').innerHTML}</tbody>
            <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td class="py-2 text-right font-semibold mono">${el('save-total').textContent}</td></tr></tfoot>
          </table>
        </div>
      </div>`;
    el('print-funds').innerHTML = fundsHtml;
  }

  // ===== Buttons =====
  el('btn-preview').onclick = ()=>{ buildPrint(); el('print-view').classList.remove('hidden'); window.scrollTo(0, el('print-view').offsetTop); };
  el('btn-print').onclick = ()=>{ buildPrint(); window.print(); };
  el('btn-print-2').onclick = ()=>{ buildPrint(); window.print(); };

  // Reset
  el('btn-reset').onclick = ()=>{
    if(!confirm('Xo√° to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) return;
    Object.assign(state, {goals:[], mustGoals:[], reasons:[], risks:[], unmitigable:[], alts:[], children:[], _priority:[]});
    document.querySelectorAll('input').forEach(i=>{
      if(i.type==='radio'){ if(i.value==='no') i.checked=true; } else i.value='';
    });
    renderChildren();
    render();
  };

  // ===== Initial render =====
  function render(){
    renderChips(state.goals, 'goals');
    syncMustGoals();
    renderChips(state.reasons, 'reasons');
    renderChips(state.risks, 'risks');
    syncUnmitigable();
    renderChips(state.alts, 'alts');
    buildPriorityList();
    updateFundsVisibility();
    calcAll();
  }
  render();
</script>
</body>
</html>
