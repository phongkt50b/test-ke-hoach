<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n ‚Äî v3 (fix add + ngƒÉn c√°ch ngh√¨n)</title>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="style.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{ --aia:#C81E26; }
    body{ font-family:"Be Vietnam Pro", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card{ background:#fff; border:1px solid #E5E7EB; border-radius:.75rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .section-title{ font-size:1.25rem; font-weight:700; color:var(--aia); }
    .form-input, .form-select{ width:100%; background:#fff; border:1px solid #D1D5DB; border-radius:.5rem; padding:.6rem .75rem; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:.6rem .9rem; border-radius:.6rem; font-weight:600; }
    .btn-primary{ background:var(--aia); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid #E5E7EB; color:#111827; }
    .chip{ display:inline-flex; align-items:center; border-radius:9999px; background:#F3F4F6; border:1px solid #E5E7EB; padding:.25rem .6rem; font-size:.9rem; margin-right:.5rem; margin-bottom:.5rem; }
    .chip button{ margin-left:.5rem; color:#6B7280; }
    .dnd .item{ padding:10px 12px; border:1px dashed #cbd5e1; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:space-between; cursor:grab; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    @media print{ .no-print{display:none!important;} .page-break{page-break-after:always;} .card{box-shadow:none;border:0} }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="flex items-center justify-between pb-6 border-b-2" style="border-color:var(--aia)">
      <div class="flex items-center gap-3">
        <img src="https://www.aia.com.vn/content/dam/group-wise/images/system/icons/aia-logo-red.svg" alt="AIA Logo" class="h-8"/>
        <h1 class="text-2xl sm:text-3xl font-bold">B·∫£n ƒë·ªì t√†i ch√≠nh c√° nh√¢n</h1>
      </div>
      <div class="flex items-center gap-2 no-print">
        <button id="btn-preview" type="button" class="btn btn-ghost">Xem b·∫£n in</button>
        <button id="btn-print" type="button" class="btn btn-primary">Xu·∫•t PDF</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6" id="app">
      <div class="lg:col-span-2 space-y-6">
        <!-- Th√¥ng tin chung -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Th√¥ng tin chung</h2><span class="text-xs text-gray-600">Ph·∫ßn ƒë·∫ßu</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block text-sm text-gray-600 mb-1">H·ªç v√† t√™n</label><input id="fullname" class="form-input" placeholder="Nguy·ªÖn VƒÉn A"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng√†y sinh</label><input id="dob" type="date" class="form-input"/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ngh·ªÅ nghi·ªáp</label><input id="job" class="form-input" placeholder="Chuy√™n vi√™n t√†i ch√≠nh..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng∆∞·ªùi ph·ª• thu·ªôc tr·ª±c ti·∫øp</label><input id="dep-direct" class="form-input" placeholder="V·ª£/ch·ªìng, con nh·ªè..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Ng∆∞·ªùi ph·ª• thu·ªôc gi√°n ti·∫øp</label><input id="dep-indirect" class="form-input" placeholder="B·ªë m·∫π, th√¢n nh√¢n..."/></div>
            <div><label class="block text-sm text-gray-600 mb-1">Video 1: Chi·∫øc thuy·ªÅn ra kh∆°i (URL)</label><input id="vid-boat" type="url" class="form-input" placeholder="https://..."/></div>
          </div>
        </section>

        <!-- Video g·∫∑p b√£o -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Video g·∫∑p b√£o</h2><span class="text-xs text-gray-600">Ph·∫ßn 8</span>
          </div>
          <label class="block text-sm text-gray-600 mb-1">Video 2: ƒêi bi·ªÉn g·∫∑p b√£o (URL)</label>
          <input id="vid-storm" type="url" class="form-input" placeholder="https://..."/>
        </section>

        <!-- M·ª•c ti√™u & b·∫Øt bu·ªôc -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">M·ª•c ti√™u/K·∫ø ho·∫°ch</h2><span class="text-xs text-gray-600">Ph·∫ßn 2 &amp; 3</span>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Th√™m m·ª•c ti√™u (g·ª£i √Ω)</label>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="md:col-span-2">
                <input id="goal-input" list="goal-suggest" class="form-input" placeholder="V√≠ d·ª•: V·∫≠n h√†nh gia ƒë√¨nh"/>
                <datalist id="goal-suggest">
                  <option value="V·∫≠n h√†nh gia ƒë√¨nh"></option>
                  <option value="Qu·ªπ h·ªçc v·∫•n cho con"></option>
                  <option value="Qu·ªπ h∆∞u tr√≠"></option>
                  <option value="Tr·∫£ n·ª£"></option>
                  <option value="Gia tƒÉng t√†i s·∫£n/ ƒê·ªÉ l·∫°i di s·∫£n"></option>
                  <option value="M·ªü doanh nghi·ªáp ri√™ng"></option>
                </datalist>
              </div>
              <div class="flex items-end"><button id="add-goal" type="button" class="btn btn-primary w-full">Th√™m m·ª•c ti√™u</button></div>
            </div>
            <div class="mt-3" id="goals"></div>
            <div class="my-4 border-t"></div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Nh·ªØng m·ª•c ti√™u b·∫Øt bu·ªôc ph·∫£i l√†m b·∫±ng m·ªçi gi√° (ch·ªçn nhi·ªÅu)</label>
            <select id="must-goals" multiple size="6" class="form-select"></select>
            <p class="text-xs text-gray-500 mt-1">Gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu.</p>
          </div>
        </section>

        <!-- L√Ω do -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">L√Ω do b·∫Øt bu·ªôc</h2><span class="text-xs text-gray-600">Ph·∫ßn 4</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm text-gray-600 mb-1">Th√™m l√Ω do</label>
              <input id="reason-input" class="form-input" placeholder="V√≠ d·ª•: B·∫£o v·ªá con c√°i tr∆∞·ªõc r·ªßi ro"/>
            </div>
            <div class="flex items-end"><button id="add-reason" type="button" class="btn btn-primary w-full">Th√™m l√Ω do</button></div>
          </div>
          <div class="mt-3" id="reasons"></div>
        </section>

        <!-- ∆Øu ti√™n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">∆Øu ti√™n m·ª•c ti√™u</h2><span class="text-xs text-gray-600">Ph·∫ßn 5</span>
          </div>
          <p class="text-gray-600 text-sm mb-2">K√©o th·∫£ t·ª´ <b>quan tr·ªçng nh·∫•t</b> xu·ªëng <b>√≠t quan tr·ªçng nh·∫•t</b>. Danh s√°ch l·∫•y t·ª´ m·ª•c 3.</p>
          <div class="dnd space-y-2" id="priority-list"></div>
        </section>

        <!-- ƒê·ªìng h√†nh & th·ªùi h·∫°n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">Th√†nh vi√™n c√πng th·ª±c hi·ªán &amp; Th·ªùi h·∫°n</h2><span class="text-xs text-gray-600">Ph·∫ßn 6 &amp; 7</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">C√≥ ai c√πng th·ª±c hi·ªán m·ª•c ti√™u kh√¥ng?</label>
              <div class="flex items-center gap-6">
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="no" checked/> Kh√¥ng</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="partner" value="yes"/> C√≥</label>
              </div>
            </div>
            <div id="partner-perc-wrap" style="display:none">
              <label class="block text-sm text-gray-600 mb-1">% c√¥ng s·ª©c c·ªßa anh/ch·ªã</label>
              <input id="partner-perc" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
            <div><label class="block text-sm text-gray-600 mb-1">D·ª± ƒë·ªãnh ho√†n th√†nh t·∫•t c·∫£ trong (nƒÉm)</label><input id="years-all" type="number" min="0" step="1" class="form-input" placeholder="S·ªë nƒÉm"/></div>
          </div>
        </section>

        <!-- R√†o c·∫£n & ph∆∞∆°ng √°n -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">R√†o c·∫£n &amp; Ph∆∞∆°ng √°n</h2><span class="text-xs text-gray-600">Ph·∫ßn 9‚Äì11</span>
          </div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">9) Y·∫øu t·ªë khi·∫øn kh√¥ng ƒë·∫°t m·ª•c ti√™u</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Th√™m y·∫øu t·ªë</label><input id="risk-input" class="form-input" placeholder="V√≠ d·ª•: ·ªêm ƒëau, th·∫•t nghi·ªáp..."/></div>
              <div class="flex items-end"><button id="add-risk" type="button" class="btn btn-primary w-full">Th√™m y·∫øu t·ªë</button></div>
            </div>
            <div id="risks" class="mt-3"></div>
          </details>
          <div class="border-t my-3"></div>
          <details open class="mb-4">
            <summary class="cursor-pointer font-semibold">10) Y·∫øu t·ªë kh√¥ng th·ªÉ l∆∞·ªùng tr∆∞·ªõc &amp; kh√¥ng th·ªÉ kh·∫Øc ph·ª•c (ch·ªçn nhi·ªÅu)</summary>
            <select id="unmit-select" multiple size="6" class="form-select w-full mt-2"></select>
            <p class="text-xs text-gray-500">Ch·ªçn t·ª´ danh s√°ch ƒë√£ nh·∫≠p ·ªü c√¢u 9.</p>
          </details>
          <div class="border-t my-3"></div>
          <details open>
            <summary class="cursor-pointer font-semibold">11) Ph∆∞∆°ng √°n thay th·∫ø</summary>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
              <div class="md:col-span-2"><label class="block text-sm text-gray-600 mb-1">Th√™m ph∆∞∆°ng √°n</label><input id="alt-input" class="form-input" placeholder="V√≠ d·ª•: D·ª± ph√≤ng 12 th√°ng chi ti√™u..."/></div>
              <div class="flex items-end"><button id="add-alt" type="button" class="btn btn-primary w-full">Th√™m ph∆∞∆°ng √°n</button></div>
            </div>
            <div id="alts" class="mt-3"></div>
          </details>
        </section>

        <!-- C√°c qu·ªπ c·∫ßn thi·∫øt -->
        <section class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title">12) C√°c qu·ªπ c·∫ßn thi·∫øt</h2><span class="text-xs text-gray-600">T·ª± ƒë·ªông hi·ªÉn th·ªã theo ∆∞u ti√™n</span>
          </div>
          <div id="funds">
            <details id="fund-family" open class="mb-4">
              <summary class="cursor-pointer font-semibold">V·∫≠n h√†nh gia ƒë√¨nh</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Chi ph√≠ thi·∫øt y·∫øu / th√°ng (‚Ç´)</label><input id="fam-monthly" type="text" inputmode="numeric" class="form-input" data-money placeholder="XX"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Trang tr·∫£i t·ªëi thi·ªÉu trong (nƒÉm)</label><input id="fam-years" type="number" min="0" step="1" class="form-input" placeholder="YY"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Qu·ªπ v·∫≠n h√†nh gia ƒë√¨nh c·∫ßn c√≥</label><div id="fam-total" class="font-bold text-[var(--aia)] mono mt-2">‚Ç´0</div></div>
              </div>
            </details>

            <details id="fund-edu" class="mb-4">
              <summary class="cursor-pointer font-semibold">Qu·ªπ h·ªçc v·∫•n ƒë·∫°i h·ªçc cho con</summary>
              <div id="children" class="mt-3"></div>
              <div class="flex items-center gap-3 mt-3">
                <button id="add-child" type="button" class="btn btn-ghost border w-fit">+ Th√™m con</button>
                <span class="text-sm text-gray-600">T·ªëi ƒëa 6 con.</span>
              </div>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">T·ªïng qu·ªπ h·ªçc v·∫•n</label><div id="edu-total" class="font-bold text-[var(--aia)] mono">‚Ç´0</div></div>
            </details>

            <details id="fund-retire" class="mb-4">
              <summary class="cursor-pointer font-semibold">Qu·ªπ h∆∞u tr√≠</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Tu·ªïi ngh·ªâ h∆∞u</label><input id="ret-age" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">S·ªëng an nh√†n trong (nƒÉm) ‚Äì xx</label><input id="ret-years" type="number" min="0" step="1" class="form-input"/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Chi ti√™u c√° nh√¢n / th√°ng ‚Äì yy (‚Ç´)</label><input id="ret-month" type="text" inputmode="numeric" class="form-input" data-money/></div>
              </div>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">T·ªïng qu·ªπ h∆∞u tr√≠ = xx √ó yy √ó 12</label><div id="ret-total" class="font-bold text-[var(--aia)] mono">‚Ç´0</div></div>
            </details>

            <details id="fund-debt" class="mb-4">
              <summary class="cursor-pointer font-semibold">Thanh kho·∫£n c√°c kho·∫£n n·ª£</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Kho·∫£n n·ª£ hi·ªán t·∫°i (‚Ç´)</label><input id="debt-amt" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Th·ªùi h·∫°n c·∫ßn tr·∫£ (nƒÉm)</label><input id="debt-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>

            <details id="fund-legacy">
              <summary class="cursor-pointer font-semibold">Gia tƒÉng t√†i s·∫£n / ƒê·ªÉ l·∫°i di s·∫£n</summary>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">Gi√° tr·ªã t√†i s·∫£n k·ª≥ v·ªçng (‚Ç´)</label><input id="legacy-amt" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div><label class="block text-sm text-gray-600 mb-1">Th·ªùi gian d·ª± ki·∫øn (nƒÉm)</label><input id="legacy-years" type="number" min="0" step="1" class="form-input"/></div>
              </div>
            </details>
          </div>
        </section>
      </div>

      <!-- B·∫£ng t·ªïng h·ª£p -->
      <aside class="lg:col-span-1">
        <section class="card p-5 sticky top-8">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">T·ªïng h·ª£p qu·ªπ tr√°ch nhi·ªám</h2>
            <button id="btn-calc" type="button" class="btn btn-ghost no-print">C·∫≠p nh·∫≠t t·ªïng h·ª£p</button>
          </div>
          <div class="grid grid-cols-1 gap-4">
            <div>
              <h3 class="font-semibold">S·ªë ti·ªÅn tr√°ch nhi·ªám ‚Äì <span class="text-gray-500">c·∫ßn lu√¥n s·∫µn s√†ng</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="resp-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td id="resp-total" class="py-2 text-right font-semibold mono">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div><label class="block text-sm text-gray-600 mb-1">S·ªë ti·ªÅn tr√°ch nhi·ªám ƒë√£ chu·∫©n b·ªã (‚Ç´)</label><input id="resp-prepared" type="text" inputmode="numeric" class="form-input" data-money/></div>
                <div class="flex flex-col"><span class="text-gray-700">Kho·∫£ng thi·∫øu (∆∞·ªõc t√≠nh)</span><span id="resp-gap" class="font-bold text-red-600 mono text-lg mt-1">‚Ç´0</span></div>
              </div>
            </div>
            <div>
              <h3 class="font-semibold">S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ ‚Äì <span class="text-gray-500">d√πng trong t∆∞∆°ng lai</span></h3>
              <table class="w-full text-sm mt-2">
                <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
                <tbody id="save-body"></tbody>
                <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td id="save-total" class="py-2 text-right font-semibold mono">‚Ç´0</td></tr></tfoot>
              </table>
              <div class="mt-3"><label class="block text-sm text-gray-600 mb-1">Mong mu·ªën ho√†n th√†nh (%)</label><input id="goal-percent" type="number" min="0" max="100" step="1" class="form-input" placeholder="%"/></div>
            </div>
          </div>
        </section>
      </aside>
    </main>

    <div class="no-print fixed bottom-0 inset-x-0 bg-white/85 backdrop-blur border-t">
      <div class="container mx-auto p-3 flex items-center gap-3">
        <p class="text-sm text-gray-600">üí° Nh·∫•n <b>Xem b·∫£n in</b> ƒë·ªÉ xem PDF tr∆∞·ªõc khi xu·∫•t.</p>
        <span class="flex-1"></span>
        <button id="btn-reset" type="button" class="btn btn-ghost">Xo√° d·ªØ li·ªáu</button>
        <button id="btn-print-2" type="button" class="btn btn-primary">Xu·∫•t PDF</button>
      </div>
    </div>

    <!-- Print preview -->
    <section id="print-view" class="mt-10 hidden">
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">T√≥m t·∫Øt kh√°ch h√†ng</h2>
        <div id="print-client" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">M·ª•c ti√™u & ∆Øu ti√™n</h2>
        <div id="print-goals" class="space-y-2"></div>
      </div>
      <div class="card p-5 page-break">
        <h2 class="section-title mb-3">C√°c qu·ªπ & T·ªïng h·ª£p</h2>
        <div id="print-funds" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== Utils =====
    const fmt = new Intl.NumberFormat('vi-VN');
    const el = id => document.getElementById(id);
    const money = v => '‚Ç´' + fmt.format(Number(v||0));
    const digitsOnly = s => (s||'').toString().replace(/\D/g,''); // b·ªè m·ªçi k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    const getNum = id => Number(digitsOnly(el(id)?.value)||0);

    // G·∫Øn mask ti·ªÅn (th√™m d·∫•u . ngƒÉn c√°ch ngh√¨n) cho m·ªçi input c√≥ data-money
    function bindMoneyMask(input){
      if(!input) return;
      const format = () => {
        const raw = digitsOnly(input.value);
        input.value = raw ? fmt.format(Number(raw)) : '';
      };
      input.addEventListener('input', (e)=>{ format(); calcAll(); });
      input.addEventListener('blur', format);
      // kh·ªüi t·∫°o n·∫øu c√≥ s·∫µn gi√° tr·ªã
      format();
    }
    function bindAllMoneyMasks(scope=document){
      scope.querySelectorAll('input[data-money]').forEach(bindMoneyMask);
    }

    const state = { goals:[], mustGoals:[], reasons:[], risks:[], unmitigable:[], alts:[], children:[], _priority:[] };

    // ===== Chips =====
    function renderChips(arr, mountId){
      const mount = el(mountId); mount.innerHTML='';
      arr.forEach((txt,i)=>{
        const chip = document.createElement('span');
        chip.className='chip';
        chip.innerHTML = '<span>'+txt+'</span><button title="Xo√°" data-i="'+i+'">√ó</button>';
        chip.querySelector('button').onclick = ()=>{ arr.splice(i,1); render(); };
        mount.appendChild(chip);
      });
    }
    function uniquePush(arr, item){
      const s = (item||'').trim(); if(!s) return; if(!arr.includes(s)) arr.push(s);
    }

    // ===== ∆Øu ti√™n (drag) =====
    function buildPriorityList(){
      const mount = el('priority-list'); mount.innerHTML='';
      let ordered = state.mustGoals.filter(g=>state._priority?.includes(g));
      const rest = state.mustGoals.filter(g=>!ordered.includes(g));
      ordered = [...(state._priority||[]).filter(x=>state.mustGoals.includes(x)), ...rest];
      state._priority = ordered;

      ordered.forEach((g)=>{
        const it = document.createElement('div');
        it.className = 'item'; it.draggable = true;
        it.innerHTML = '<span class="mono">‚ò∞</span> <span>'+g+'</span>';
        it.addEventListener('dragstart', e=>{ it.classList.add('dragging'); e.dataTransfer.setData('text/plain', g); });
        it.addEventListener('dragend', ()=> it.classList.remove('dragging'));
        mount.appendChild(it);
      });
      mount.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const dragging = mount.querySelector('.dragging');
        const after = getDragAfterElement(mount, e.clientY);
        if(!dragging) return;
        if(after == null) mount.appendChild(dragging); else mount.insertBefore(dragging, after);
      });
      mount.addEventListener('drop', ()=>{
        const items = Array.from(mount.querySelectorAll('.item')).map(x=>x.textContent.trim());
        state._priority = items.map(t=>t.replace(/^‚ò∞\s*/,'')); updateFundsVisibility(); calcAll();
      });
      function getDragAfterElement(container,y){
        const els=[...container.querySelectorAll('.item:not(.dragging)')];
        return els.reduce((closest,child)=>{
          const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2;
          if(offset<0 && offset>closest.offset) return {offset,element:child}; else return closest;
        },{offset:Number.NEGATIVE_INFINITY}).element;
      }
    }

    // ===== Select sync =====
    function syncMustGoals(){
      const sel = el('must-goals'); sel.innerHTML='';
      state.goals.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sel.appendChild(o); });
      Array.from(sel.options).forEach(o=> o.selected = state.mustGoals.includes(o.value));
    }
    function syncUnmitigable(){
      const sel = el('unmit-select'); sel.innerHTML='';
      state.risks.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
      Array.from(sel.options).forEach(o=> o.selected = state.unmitigable.includes(o.value));
    }

    // ===== Children =====
    const childMax = 6;
    function childRow(idx,data){
      const wrap = document.createElement('div');
      wrap.className='card p-4 mt-3 border border-gray-200';
      wrap.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-sm text-gray-600 mb-1">Con th·ª© #${idx+1} - H·ªç t√™n</label><input data-k="name" class="form-input" value="${data?.name||''}" placeholder="T√™n con"/></div>
          <div><label class="block text-sm text-gray-600 mb-1">Tr∆∞·ªùng d·ª± ƒë·ªãnh</label><input data-k="school" class="form-input" value="${data?.school||''}" placeholder="T√™n tr∆∞·ªùng"/></div>
          <div><label class="block text-sm text-gray-600 mb-1">Chi ph√≠ 1 nƒÉm (‚Ç´)</label><input data-k="cost" class="form-input" data-money value="${data?.cost?fmt.format(data.cost):''}" inputmode="numeric" placeholder=""/></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
          <div><label class="block text-sm text-gray-600 mb-1">S·ªë nƒÉm h·ªçc ƒë·∫°i h·ªçc</label><input data-k="years" type="number" min="0" step="1" class="form-input" value="${data?.years||''}"/></div>
          <div class="flex flex-col justify-center"><div class="text-sm text-gray-600">T·ªïng h·ªçc ph√≠ (#${idx+1})</div><div class="font-bold text-[var(--aia)] mono child-total">‚Ç´0</div></div>
          <div class="flex items-center justify-end"><button class="btn btn-ghost border text-red-600" type="button">Xo√°</button></div>
        </div>`;
      // bind inputs
      wrap.querySelectorAll('input[data-k]').forEach(inp=>{
        const k = inp.getAttribute('data-k');
        if(k==='cost'){ bindMoneyMask(inp); }
        inp.addEventListener('input', ()=>{
          let v = inp.value;
          if(k==='cost'){ v = Number(digitsOnly(v)||0); }
          if(k==='years'){ v = Number(v||0); }
          state.children[idx][k] = (k==='name'||k==='school') ? v : Number(v||0);
          calcEdu(); calcAll();
        });
      });
      wrap.querySelector('button').onclick = ()=>{ state.children.splice(idx,1); renderChildren(); calcAll(); };
      return wrap;
    }
    function renderChildren(){
      const mount = el('children'); mount.innerHTML='';
      state.children.forEach((c,i)=> mount.appendChild(childRow(i,c)));
      // mask ƒë√£ g·∫Øn trong childRow; ch·ªâ c·∫ßn t√≠nh l·∫°i
      calcEdu(); calcAll();
    }

    // ===== Visibility theo ∆∞u ti√™n =====
    function updateFundsVisibility(){
      const names = (state._priority||[]).map(s=>s.trim().toLowerCase());
      const show = {
        'fund-family': names.includes('v·∫≠n h√†nh gia ƒë√¨nh'),
        'fund-edu': names.includes('qu·ªπ h·ªçc v·∫•n cho con'),
        'fund-retire': names.includes('qu·ªπ h∆∞u tr√≠'),
        'fund-debt': names.includes('tr·∫£ n·ª£'),
        'fund-legacy': names.includes('gia tƒÉng t√†i s·∫£n/ ƒë·ªÉ l·∫°i di s·∫£n') || names.includes('gia tƒÉng t√†i s·∫£n') || names.includes('ƒë·ªÉ l·∫°i di s·∫£n')
      };
      Object.entries(show).forEach(([id,on])=>{ const d=el(id); if(d) d.style.display = on?'block':'none'; });
    }

    // ===== T√≠nh to√°n =====
    function calcFamily(){ const total = getNum('fam-monthly') * 12 * Number(el('fam-years').value||0); el('fam-total').textContent = money(total); return total; }
    function calcEdu(){
      let sum=0;
      state.children.forEach((c,i)=>{
        const t = Number(c.cost||0) * Number(c.years||0); sum += t;
        const mount = el('children').children[i]; if(mount){ const tv = mount.querySelector('.child-total'); if(tv) tv.textContent = money(t); }
      });
      el('edu-total').textContent = money(sum); return sum;
    }
    function calcRetire(){ const xx=Number(el('ret-years').value||0); const yy=getNum('ret-month'); const total=xx*yy*12; el('ret-total').textContent = money(total); return total; }
    const calcDebt = ()=> getNum('debt-amt');
    const calcLegacy = ()=> getNum('legacy-amt');

    function calcAll(){
      const fam = calcFamily();
      const edu = calcEdu();
      const ret = calcRetire();
      const debt = calcDebt();
      const leg = calcLegacy();

      const respItems=[];
      if(el('fund-family').style.display!=='none') respItems.push(['V·∫≠n h√†nh gia ƒë√¨nh', fam]);
      if(el('fund-edu').style.display!=='none') respItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
      if(el('fund-debt').style.display!=='none') respItems.push(['Thanh kho·∫£n c√°c kho·∫£n n·ª£', debt]);
      if(el('fund-legacy').style.display!=='none') respItems.push(['ƒê·ªÉ l·∫°i di s·∫£n', leg]);
      el('resp-body').innerHTML = respItems.map(([k,v])=>`<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
      const respSum = respItems.reduce((a,[,v])=>a+Number(v||0),0);
      el('resp-total').textContent = money(respSum);

      const prepared = getNum('resp-prepared');
      el('resp-gap').textContent = money(Math.max(respSum - prepared, 0));

      const saveItems=[];
      if(el('fund-retire').style.display!=='none') saveItems.push(['Qu·ªπ h∆∞u tr√≠', ret]);
      if(el('fund-edu').style.display!=='none') saveItems.push(['Qu·ªπ h·ªçc v·∫•n cho con', edu]);
      el('save-body').innerHTML = saveItems.map(([k,v])=>`<tr><td class="py-1">${k}</td><td class="py-1 text-right mono">${money(v)}</td></tr>`).join('');
      const saveSum = saveItems.reduce((a,[,v])=>a+Number(v||0),0);
      el('save-total').textContent = money(saveSum);
    }

    // ===== Buttons & events =====
    document.getElementById('add-goal').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.goals, el('goal-input').value); el('goal-input').value=''; render(); });
    document.getElementById('add-reason').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.reasons, el('reason-input').value); el('reason-input').value=''; render(); });
    document.getElementById('add-risk').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.risks, el('risk-input').value); el('risk-input').value=''; render(); });
    document.getElementById('add-alt').addEventListener('click', (e)=>{ e.preventDefault(); uniquePush(state.alts, el('alt-input').value); el('alt-input').value=''; render(); });

    document.getElementById('must-goals').addEventListener('change', ()=>{ const sel=el('must-goals'); state.mustGoals = Array.from(sel.selectedOptions).map(o=>o.value); render(); });
    document.getElementById('unmit-select').addEventListener('change', ()=>{ const sel=el('unmit-select'); state.unmitigable = Array.from(sel.selectedOptions).map(o=>o.value); });

    Array.from(document.querySelectorAll('input[name="partner"]')).forEach(r=>{
      r.addEventListener('change', ()=>{ el('partner-perc-wrap').style.display = (r.value==='yes' && r.checked) ? 'block':'none'; });
    });

    document.getElementById('btn-calc').addEventListener('click', calcAll);
    document.getElementById('btn-preview').addEventListener('click', ()=>{ buildPrint(); el('print-view').classList.remove('hidden'); window.scrollTo(0, el('print-view').offsetTop); });
    document.getElementById('btn-print').addEventListener('click', ()=>{ buildPrint(); window.print(); });
    document.getElementById('btn-print-2').addEventListener('click', ()=>{ buildPrint(); window.print(); });
    document.getElementById('btn-reset').addEventListener('click', ()=>{
      if(!confirm('Xo√° to√†n b·ªô d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) return;
      Object.assign(state,{goals:[],mustGoals:[],reasons:[],risks:[],unmitigable:[],alts:[],children:[],_priority:[]});
      document.querySelectorAll('input').forEach(i=>{ if(i.type==='radio'){ if(i.value==='no') i.checked=true; } else i.value=''; });
      renderChildren(); render();
    });

    // ===== Print =====
    function buildPrint(){
      const client = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><div class="text-sm text-gray-500">H·ªç v√† t√™n</div><div class="mono">${el('fullname').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Ng√†y sinh</div><div class="mono">${el('dob').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Ngh·ªÅ nghi·ªáp</div><div class="mono">${el('job').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Ph·ª• thu·ªôc tr·ª±c ti·∫øp</div><div class="mono">${el('dep-direct').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Ph·ª• thu·ªôc gi√°n ti·∫øp</div><div class="mono">${el('dep-indirect').value||''}</div></div>
          <div><div class="text-sm text-gray-500">Video: Chi·∫øc thuy·ªÅn (URL)</div><div class="mono">${el('vid-boat').value||''}</div></div>
          <div class="md:col-span-2"><div class="text-sm text-gray-500">Video: G·∫∑p b√£o (URL)</div><div class="mono">${el('vid-storm').value||''}</div></div>
        </div>`;
      el('print-client').innerHTML = client;

      const goalsHtml = `
        <div><span class="text-gray-600">T·∫•t c·∫£ m·ª•c ti√™u:</span> <span class="font-medium">${state.goals.join(' ¬∑ ')||'‚Äî'}</span></div>
        <div><span class="text-gray-600">M·ª•c ti√™u b·∫Øt bu·ªôc:</span> <span class="font-medium">${state.mustGoals.join(' ¬∑ ')||'‚Äî'}</span></div>
        <div><span class="text-gray-600">∆Øu ti√™n:</span><div class="mt-1">${(state._priority||[]).map((g,i)=>(i+1)+'. '+g).join('<br/>')||'‚Äî'}</div></div>
        <hr class="my-2"/>
        <div><span class="text-gray-600">L√Ω do:</span> <span class="font-medium">${state.reasons.join(' ¬∑ ')||'‚Äî'}</span></div>
        <div><span class="text-gray-600">Y·∫øu t·ªë c·∫£n tr·ªü:</span> <span class="font-medium">${state.risks.join(' ¬∑ ')||'‚Äî'}</span></div>
        <div><span class="text-gray-600">Kh√¥ng l∆∞·ªùng tr∆∞·ªõc/kh√≥ kh·∫Øc ph·ª•c:</span> <span class="font-medium">${state.unmitigable.join(' ¬∑ ')||'‚Äî'}</span></div>
        <div><span class="text-gray-600">Ph∆∞∆°ng √°n thay th·∫ø:</span> <span class="font-medium">${state.alts.join(' ¬∑ ')||'‚Äî'}</span></div>`;
      el('print-goals').innerHTML = goalsHtml;

      calcAll();
      const fundsHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold mb-2">S·ªë ti·ªÅn tr√°ch nhi·ªám</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
              <tbody>${el('resp-body').innerHTML}</tbody>
              <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td class="py-2 text-right font-semibold mono">${el('resp-total').textContent}</td></tr></tfoot>
            </table>
          </div>
          <div>
            <h3 class="font-semibold mb-2">S·ªë ti·ªÅn ph·∫£i t√≠ch lu·ªπ</h3>
            <table class="w-full text-sm">
              <thead><tr class="text-left"><th class="py-2">M·ª•c</th><th class="py-2 text-right">S·ªë ti·ªÅn (‚Ç´)</th></tr></thead>
              <tbody>${el('save-body').innerHTML}</tbody>
              <tfoot><tr><td class="py-2 font-semibold">T·ªïng</td><td class="py-2 text-right font-semibold mono">${el('save-total').textContent}</td></tr></tfoot>
            </table>
          </div>
        </div>`;
      el('print-funds').innerHTML = fundsHtml;
    }

    // ===== Render init =====
    function render(){
      renderChips(state.goals,'goals'); syncMustGoals();
      renderChips(state.reasons,'reasons');
      renderChips(state.risks,'risks'); syncUnmitigable();
      renderChips(state.alts,'alts');
      buildPriorityList(); updateFundsVisibility(); calcAll();
    }
    // init masks (to√†n trang)
    bindAllMoneyMasks(document);
    render();

    // th√™m con
    document.getElementById('add-child').addEventListener('click', ()=>{
      if(state.children.length>=childMax) return alert('T·ªëi ƒëa 6 con.');
      state.children.push({name:'',school:'',cost:0,years:0});
      renderChildren();
    });
  </script>
</body>
</html>
